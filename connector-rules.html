<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connector-Based Analytics Rules - Microsoft Sentinel Guide</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Sentinel Guide
        </a>
        <ul class="navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="architecture.html">Architecture</a></li>
            <li><a href="data-connectors.html">Connectors</a></li>
            <li><a href="analytics-rules.html">Analytics</a></li>
            <li><a href="kql-library.html">KQL Library</a></li>
            <li><a href="automation.html">Automation</a></li>
        </ul>
        <button class="mobile-toggle" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24" fill="none">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Getting Started</div>
            <ul class="sidebar-nav">
                <li><a href="index.html">Home</a></li>
                <li><a href="architecture.html">Architecture</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Data Collection</div>
            <ul class="sidebar-nav">
                <li><a href="data-connectors.html">Data Connectors</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Detection & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="analytics-rules.html">Analytics Rules</a></li>
                <li><a href="connector-rules.html" class="active">Connector Rules</a></li>
                <li><a href="correlation-rules.html">Correlation Rules</a></li>
                <li><a href="kql-library.html">KQL Library</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Investigation & Response</div>
            <ul class="sidebar-nav">
                <li><a href="incidents.html">Incidents</a></li>
                <li><a href="automation.html">Automation & SOAR</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Intelligence & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="workbooks.html">Workbooks</a></li>
                <li><a href="threat-intelligence.html">Threat Intelligence</a></li>
                <li><a href="ueba.html">UEBA</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Management</div>
            <ul class="sidebar-nav">
                <li><a href="content-hub.html">Content Hub</a></li>
                <li><a href="costs.html">Pricing & Costs</a></li>
                <li><a href="best-practices.html">Best Practices</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Quick Resources</div>
            <ul class="sidebar-nav">
                <li><a href="kql-cheatsheet.html">KQL Cheat Sheet</a></li>
                <li><a href="deployment-checklist.html">Deployment Checklist</a></li>
                <li><a href="interview-prep.html">Interview Prep</a></li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <h1>Connector-Based Analytics Rules</h1>
            <p>Ready-to-deploy detection rules organized by data connector. Each rule includes complete KQL, entity mapping, MITRE ATT&CK alignment, and tuning recommendations.</p>

            <!-- Table of Contents -->
            <div class="toc">
                <div class="toc-title">Connectors Covered</div>
                <ul class="toc-list">
                    <li><a href="#mde">Microsoft Defender for Endpoint</a></li>
                    <li><a href="#mdi">Microsoft Defender for Identity</a></li>
                    <li><a href="#mdo">Microsoft Defender for Office 365</a></li>
                    <li><a href="#aad">Azure Active Directory / Entra ID</a></li>
                    <li><a href="#azure">Azure Activity & Resources</a></li>
                    <li><a href="#windows">Windows Security Events</a></li>
                    <li><a href="#linux">Linux Syslog</a></li>
                    <li><a href="#firewall">Firewall (Palo Alto, Fortinet)</a></li>
                </ul>
            </div>

            <!-- MDE Rules -->
            <h2 id="mde">Microsoft Defender for Endpoint (MDE)</h2>
            <p>Detection rules leveraging MDE telemetry from DeviceProcessEvents, DeviceNetworkEvents, DeviceFileEvents, and related tables.</p>

            <h3>Tables Used</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Table</th>
                            <th>Description</th>
                            <th>Key Fields</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>DeviceProcessEvents</code></td>
                            <td>Process creation events</td>
                            <td>FileName, ProcessCommandLine, AccountName, DeviceName</td>
                        </tr>
                        <tr>
                            <td><code>DeviceNetworkEvents</code></td>
                            <td>Network connections</td>
                            <td>RemoteIP, RemotePort, RemoteUrl, InitiatingProcessFileName</td>
                        </tr>
                        <tr>
                            <td><code>DeviceFileEvents</code></td>
                            <td>File operations</td>
                            <td>FileName, FolderPath, ActionType, SHA256</td>
                        </tr>
                        <tr>
                            <td><code>DeviceLogonEvents</code></td>
                            <td>Login events</td>
                            <td>AccountName, LogonType, RemoteIP</td>
                        </tr>
                        <tr>
                            <td><code>DeviceRegistryEvents</code></td>
                            <td>Registry modifications</td>
                            <td>RegistryKey, RegistryValueName, ActionType</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- MDE Rule 1: Ransomware -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Ransomware - Mass File Encryption Detected</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1486</span>
                        <span class="tag">Impact</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects rapid file modifications with encryption-related extensions, indicating potential ransomware activity.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let timeWindow = 5m;
let fileThreshold = 50;
let ransomwareExtensions = dynamic([
    ".encrypted", ".locked", ".crypto", ".crypt", ".enc", ".locky",
    ".cerber", ".zepto", ".thor", ".zzzzz", ".aaa", ".xyz", ".abc",
    ".micro", ".crypted", ".fucked", ".lol", ".WNCRY", ".WCRY"
]);
DeviceFileEvents
| where TimeGenerated > ago(timeWindow)
| where ActionType in ("FileCreated", "FileModified", "FileRenamed")
| where FileName has_any (ransomwareExtensions)
    or FileName matches regex @"\.[a-zA-Z0-9]{5,10}$"
| summarize 
    FileCount = count(),
    AffectedFolders = dcount(FolderPath),
    SampleFiles = make_set(FileName, 10),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated)
    by DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, AccountName
| where FileCount >= fileThreshold
| extend 
    FilesPerMinute = FileCount / datetime_diff('minute', LastSeen, FirstSeen),
    Duration = LastSeen - FirstSeen
| project
    TimeGenerated = LastSeen,
    DeviceName,
    AccountName,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileCount,
    AffectedFolders,
    FilesPerMinute,
    Duration,
    SampleFiles</pre>
                            </div>
                        </div>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Entity Mapping</div>
                        <p>Host: DeviceName | Account: AccountName | Process: InitiatingProcessCommandLine</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Recommended Response</div>
                        <p>Immediately isolate device via MDE API, disable user account, trigger incident response playbook.</p>
                    </div>
                </div>
            </div>

            <!-- MDE Rule 2: Credential Dumping -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">LSASS Memory Access - Credential Dumping</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1003.001</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects processes accessing LSASS memory, commonly used by tools like Mimikatz, ProcDump, and comsvcs.dll for credential theft.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let trustedProcesses = dynamic([
    "csrss.exe", "lsass.exe", "services.exe", "smss.exe", 
    "svchost.exe", "wininit.exe", "MsMpEng.exe", "MsSense.exe"
]);
DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where (
    // Direct LSASS access via process creation
    (FileName =~ "procdump.exe" and ProcessCommandLine has "lsass")
    or (FileName =~ "rundll32.exe" and ProcessCommandLine has "comsvcs.dll" and ProcessCommandLine has "MiniDump")
    or (FileName =~ "taskmgr.exe" and ProcessCommandLine has "lsass")
    or ProcessCommandLine has_any ("sekurlsa", "lsadump", "mimikatz")
    // Suspicious command lines
    or (ProcessCommandLine has "lsass" and ProcessCommandLine has_any ("dump", "minidump", "writeminidump"))
    )
| where InitiatingProcessFileName !in (trustedProcesses)
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    AccountDomain,
    FileName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FolderPath</pre>
                            </div>
                        </div>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">False Positives</div>
                        <p>Security tools performing memory analysis, legitimate crash dump collection (Windows Error Reporting).</p>
                    </div>
                </div>
            </div>

            <!-- MDE Rule 3: Lateral Movement -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Lateral Movement via PsExec/WMI</h4>
                    <div class="rule-meta">
                        <span class="tag tag-yellow">Medium</span>
                        <span class="tag tag-blue">T1021.002</span>
                        <span class="tag">Lateral Movement</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Detect PsExec service installation and WMI process creation
let psexecIndicators = DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where (
    // PsExec execution
    FileName =~ "PSEXESVC.exe"
    or (FileName =~ "psexec.exe" and ProcessCommandLine has @"\\")
    or (FileName =~ "psexec64.exe")
    // WMI remote execution
    or (FileName =~ "wmiprvse.exe" and InitiatingProcessFileName =~ "svchost.exe")
    // WinRM remote execution
    or (FileName =~ "wsmprovhost.exe")
);
// Correlate with network connections to internal IPs
let networkActivity = DeviceNetworkEvents
| where TimeGenerated > ago(1h)
| where RemotePort in (445, 135, 139, 5985, 5986) // SMB, RPC, WinRM
| where RemoteIPType == "Private"
| summarize 
    TargetHosts = make_set(RemoteIP),
    ConnectionCount = count()
    by DeviceName, InitiatingProcessFileName;
psexecIndicators
| join kind=inner networkActivity on DeviceName
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    FileName,
    ProcessCommandLine,
    TargetHosts,
    ConnectionCount</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MDE Rule 4: Cobalt Strike -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Cobalt Strike Beacon Indicators</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1071.001</span>
                        <span class="tag">Command and Control</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Named pipe indicators
let namedPipeIndicators = DeviceEvents
| where TimeGenerated > ago(1h)
| where ActionType == "NamedPipeEvent"
| where AdditionalFields has_any (
    "\\MSSE-", "\\postex_", "\\status_", "\\msagent_",
    "\\MSSE-", "\\postex_ssh", "\\postex_"
);
// Process injection indicators
let injectionIndicators = DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where (
    // Rundll32 with suspicious arguments
    (FileName =~ "rundll32.exe" and ProcessCommandLine matches regex @"[A-Za-z0-9+/]{50,}")
    // PowerShell with base64
    or (FileName =~ "powershell.exe" and ProcessCommandLine has "-enc" 
        and ProcessCommandLine matches regex @"[A-Za-z0-9+/]{100,}")
    // Regsvr32 proxy execution
    or (FileName =~ "regsvr32.exe" and ProcessCommandLine has "/s /n /u /i:")
);
// Network beaconing pattern
let beaconingIndicators = DeviceNetworkEvents
| where TimeGenerated > ago(1h)
| where RemotePort in (80, 443, 8080, 8443)
| summarize 
    ConnectionCount = count(),
    AvgInterval = avg(datetime_diff('second', TimeGenerated, prev(TimeGenerated)))
    by DeviceName, RemoteIP, RemotePort, bin(TimeGenerated, 5m)
| where ConnectionCount >= 10 and AvgInterval between (50 .. 70);
union namedPipeIndicators, injectionIndicators, beaconingIndicators</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MDI Rules -->
            <h2 id="mdi">Microsoft Defender for Identity (MDI)</h2>
            <p>Detection rules for Active Directory threats using IdentityLogonEvents, IdentityQueryEvents, and IdentityDirectoryEvents.</p>

            <!-- MDI Rule 1: DCSync -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Suspected DCSync Attack</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1003.006</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects replication requests from non-domain controller sources, indicating potential DCSync attack for credential harvesting.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Get list of known Domain Controllers
let domainControllers = IdentityDirectoryEvents
| where TimeGenerated > ago(7d)
| where Application == "Active Directory"
| where ActionType == "Directory Service Access"
| where DestinationDeviceName has "DC"
| distinct DestinationDeviceName;
// Detect replication from non-DC sources
IdentityDirectoryEvents
| where TimeGenerated > ago(1h)
| where ActionType == "Directory Service Replication"
| where DestinationDeviceName !in (domainControllers)
| project 
    TimeGenerated,
    SourceDeviceName = DestinationDeviceName,
    TargetDC = TargetDeviceName,
    AccountName,
    AccountDomain,
    Protocol,
    ReplicationType = ActionType
| extend AlertDetails = strcat(
    "DCSync attack suspected from ", SourceDeviceName,
    " by user ", AccountDomain, "\\", AccountName
)</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MDI Rule 2: Kerberoasting -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Kerberoasting Attack Detection</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1558.003</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let threshold = 5; // Number of SPN requests in time window
let timeWindow = 10m;
IdentityQueryEvents
| where TimeGenerated > ago(timeWindow)
| where ActionType == "SAMR query" or QueryType == "ServicePrincipalName"
| where Application == "Active Directory"
| summarize 
    SPNRequestCount = count(),
    TargetAccounts = make_set(TargetAccountDisplayName),
    QueryTypes = make_set(QueryType)
    by AccountName, AccountDomain, DeviceName, bin(TimeGenerated, timeWindow)
| where SPNRequestCount >= threshold
| project 
    TimeGenerated,
    AccountName,
    AccountDomain,
    DeviceName,
    SPNRequestCount,
    TargetAccounts,
    Alert = "Potential Kerberoasting - Multiple SPN queries from single account"</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Azure AD Rules -->
            <h2 id="aad">Azure Active Directory / Entra ID</h2>
            <p>Detection rules for identity-based attacks using SigninLogs and AuditLogs.</p>

            <!-- AAD Rule 1: MFA Fatigue -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">MFA Fatigue Attack Detection</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1621</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects multiple MFA denials followed by an approval, indicating potential MFA push fatigue/bombing attack where user accidentally approves after repeated prompts.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let mfaDenialThreshold = 5;
let timeWindow = 30m;
// Get MFA denials
let mfaDenials = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType in ("50074", "50076", "500121") // MFA required/denied
| where Status.additionalDetails has_any ("MFA denied", "MFA not completed", "User declined")
| summarize 
    DenialCount = count(),
    DenialTimes = make_list(TimeGenerated)
    by UserPrincipalName, IPAddress;
// Get successful logins after denials
let successfulLogins = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType == "0" // Success
| where AuthenticationRequirement == "multiFactorAuthentication"
| project UserPrincipalName, IPAddress, SuccessTime = TimeGenerated, AppDisplayName, Location;
// Correlate - denial followed by success
mfaDenials
| where DenialCount >= mfaDenialThreshold
| join kind=inner successfulLogins on UserPrincipalName
| where SuccessTime > todatetime(DenialTimes[-1]) // Success after last denial
| project 
    TimeGenerated = SuccessTime,
    UserPrincipalName,
    IPAddress,
    DenialCount,
    AppDisplayName,
    Location,
    Alert = "MFA Fatigue Attack - Multiple denials followed by approval"</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AAD Rule 2: Password Spray -->
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Password Spray Detection</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1110.003</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let userThreshold = 10; // Multiple users targeted
let successRatio = 0.1; // Low success ratio indicates spray
let timeWindow = 30m;
SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType in ("50126", "50053", "50055", "50056") // Password failures
| summarize 
    FailedUsers = dcount(UserPrincipalName),
    FailedAttempts = count(),
    TargetedUsers = make_set(UserPrincipalName, 20),
    UserAgents = make_set(UserAgent, 5)
    by IPAddress, bin(TimeGenerated, 10m)
| where FailedUsers >= userThreshold
// Check for any successes from same IP
| join kind=leftouter (
    SigninLogs
    | where TimeGenerated > ago(timeWindow)
    | where ResultType == "0"
    | summarize SuccessfulUsers = make_set(UserPrincipalName) by IPAddress
) on IPAddress
| extend 
    HasSuccess = isnotempty(SuccessfulUsers),
    SuccessRate = todouble(array_length(SuccessfulUsers)) / todouble(FailedUsers)
| project 
    TimeGenerated,
    IPAddress,
    FailedUsers,
    FailedAttempts,
    TargetedUsers,
    HasSuccess,
    SuccessfulUsers,
    SuccessRate,
    UserAgents</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Azure Rules -->
            <h2 id="azure">Azure Activity & Resources</h2>
            <p>Detection rules for Azure infrastructure threats using AzureActivity and AzureDiagnostics.</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Azure Key Vault Secret Access from Unusual IP</h4>
                    <div class="rule-meta">
                        <span class="tag tag-yellow">Medium</span>
                        <span class="tag tag-blue">T1552.001</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Build baseline of known IPs accessing Key Vault
let baselineIPs = AzureDiagnostics
| where TimeGenerated > ago(30d) and TimeGenerated < ago(1d)
| where ResourceType == "VAULTS"
| where OperationName in ("SecretGet", "SecretList", "KeyGet", "CertificateGet")
| summarize by CallerIPAddress;
// Detect access from new IPs
AzureDiagnostics
| where TimeGenerated > ago(1h)
| where ResourceType == "VAULTS"
| where OperationName in ("SecretGet", "SecretList", "KeyGet", "CertificateGet")
| where ResultType == "Success"
| where CallerIPAddress !in (baselineIPs)
| project 
    TimeGenerated,
    ResourceGroup,
    Resource,
    OperationName,
    CallerIPAddress,
    identity_claim_upn_s,
    id_s,
    requestUri_s
| extend 
    KeyVaultName = Resource,
    User = identity_claim_upn_s,
    SecretName = extract(@"secrets/([^/]+)", 1, requestUri_s)</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Windows Events -->
            <h2 id="windows">Windows Security Events</h2>
            <p>Detection rules using Windows Security Event Log via SecurityEvent table.</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Audit Log Cleared (Event 1102)</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1070.001</span>
                        <span class="tag">Defense Evasion</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID == 1102
| project 
    TimeGenerated,
    Computer,
    Account,
    Activity,
    LogName = "Security",
    Alert = "Security audit log was cleared - potential evidence destruction"
| extend 
    AccountName = tostring(split(Account, @"\")[1]),
    AccountDomain = tostring(split(Account, @"\")[0])</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Suspicious Process Creation (Event 4688)</h4>
                    <div class="rule-meta">
                        <span class="tag tag-yellow">Medium</span>
                        <span class="tag tag-blue">T1059</span>
                        <span class="tag">Execution</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID == 4688
| where CommandLine has_any (
    // Encoded commands
    "-enc", "-encodedcommand", "FromBase64String",
    // Download cradles
    "Invoke-WebRequest", "wget", "curl", "DownloadString", "DownloadFile",
    // Reconnaissance
    "whoami", "net user", "net group", "nltest", "dsquery",
    // Credential access
    "mimikatz", "procdump", "sekurlsa",
    // Persistence
    "schtasks /create", "reg add", "sc create"
)
| project 
    TimeGenerated,
    Computer,
    Account,
    NewProcessName,
    CommandLine,
    ParentProcessName,
    SubjectUserSid
| extend 
    ThreatCategory = case(
        CommandLine has_any ("-enc", "FromBase64String"), "Obfuscation",
        CommandLine has_any ("Invoke-WebRequest", "DownloadString"), "Download",
        CommandLine has_any ("whoami", "net user"), "Reconnaissance",
        CommandLine has_any ("mimikatz", "sekurlsa"), "Credential Theft",
        "Other"
    )</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Linux -->
            <h2 id="linux">Linux Syslog</h2>
            <p>Detection rules for Linux-based threats using Syslog table.</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">SSH Brute Force Detection</h4>
                    <div class="rule-meta">
                        <span class="tag tag-yellow">Medium</span>
                        <span class="tag tag-blue">T1110.001</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let threshold = 20;
let timeWindow = 5m;
Syslog
| where TimeGenerated > ago(timeWindow)
| where Facility == "auth" or Facility == "authpriv"
| where SyslogMessage has "Failed password" or SyslogMessage has "Invalid user"
| parse SyslogMessage with * "from " SourceIP " port" *
| summarize 
    FailedAttempts = count(),
    TargetUsers = make_set(extract(@"for (\w+)", 1, SyslogMessage)),
    FirstAttempt = min(TimeGenerated),
    LastAttempt = max(TimeGenerated)
    by Computer, SourceIP
| where FailedAttempts >= threshold
| extend 
    AttackDuration = LastAttempt - FirstAttempt,
    AttemptsPerMinute = FailedAttempts / datetime_diff('minute', LastAttempt, FirstAttempt)
| project 
    TimeGenerated = LastAttempt,
    Computer,
    SourceIP,
    FailedAttempts,
    TargetUsers,
    AttackDuration,
    AttemptsPerMinute</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Firewall -->
            <h2 id="firewall">Firewall (Palo Alto, Fortinet, Azure Firewall)</h2>
            <p>Detection rules for network-based threats using CommonSecurityLog (CEF format).</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Outbound Connection to Known C2 Infrastructure</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1071</span>
                        <span class="tag">Command and Control</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Use Threat Intelligence for IOC matching
let maliciousIPs = ThreatIntelligenceIndicator
| where TimeGenerated > ago(30d)
| where isnotempty(NetworkIP)
| where Active == true
| distinct NetworkIP;
let maliciousDomains = ThreatIntelligenceIndicator
| where TimeGenerated > ago(30d)
| where isnotempty(DomainName)
| where Active == true
| distinct DomainName;
CommonSecurityLog
| where TimeGenerated > ago(1h)
| where DeviceVendor in ("Palo Alto Networks", "Fortinet", "Cisco")
| where DeviceAction != "deny" and DeviceAction != "blocked"
| where (
    DestinationIP in (maliciousIPs)
    or DestinationHostName in (maliciousDomains)
    or RequestURL has_any (maliciousDomains)
)
| project 
    TimeGenerated,
    DeviceVendor,
    SourceIP,
    SourceUserName,
    DestinationIP,
    DestinationHostName,
    DestinationPort,
    RequestURL,
    DeviceAction,
    ApplicationProtocol,
    SentBytes,
    ReceivedBytes</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Beaconing Behavior Detection</h4>
                    <div class="rule-meta">
                        <span class="tag tag-yellow">Medium</span>
                        <span class="tag tag-blue">T1071.001</span>
                        <span class="tag">Command and Control</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let minConnections = 20;
let jitterThreshold = 0.2; // 20% variance indicates beaconing
CommonSecurityLog
| where TimeGenerated > ago(4h)
| where DestinationPort in (80, 443, 8080, 8443)
| summarize 
    Timestamps = make_list(TimeGenerated),
    ConnectionCount = count(),
    TotalBytes = sum(SentBytes + ReceivedBytes)
    by SourceIP, DestinationIP, DestinationPort
| where ConnectionCount >= minConnections
| extend 
    SortedTimestamps = array_sort_asc(Timestamps)
| mv-apply SortedTimestamps to typeof(datetime) on (
    extend NextTimestamp = next(SortedTimestamps)
    | extend Interval = datetime_diff('second', NextTimestamp, SortedTimestamps)
    | where isnotnull(Interval)
    | summarize 
        Intervals = make_list(Interval),
        AvgInterval = avg(Interval),
        StdDevInterval = stdev(Interval)
)
| extend 
    Jitter = StdDevInterval / AvgInterval
| where Jitter < jitterThreshold and AvgInterval > 30 // Regular interval with low jitter
| project 
    SourceIP,
    DestinationIP,
    DestinationPort,
    ConnectionCount,
    AvgIntervalSeconds = AvgInterval,
    Jitter,
    TotalBytes,
    BeaconingScore = 1 - Jitter // Higher score = more likely beaconing</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                </svg>
                <div class="alert-content">
                    <div class="alert-title">More Rules Available</div>
                    <p class="alert-text">See the <a href="correlation-rules.html">Correlation Rules</a> page for multi-connector detection scenarios and attack chain detection.</p>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="footer-content">
                    <svg class="footer-icon" viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    Microsoft Sentinel Ultimate Guide
                </div>
            </footer>
        </div>
    </main>

    <script src="main.js"></script>
</body>
</html>
