<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Rules - Microsoft Sentinel Guide</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Sentinel Guide
        </a>
        <ul class="navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="architecture.html">Architecture</a></li>
            <li><a href="data-connectors.html">Connectors</a></li>
            <li><a href="analytics-rules.html" class="active">Analytics</a></li>
            <li><a href="kql-library.html">KQL Library</a></li>
            <li><a href="automation.html">Automation</a></li>
        </ul>
        <button class="mobile-toggle" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24" fill="none">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Getting Started</div>
            <ul class="sidebar-nav">
                <li><a href="index.html">Home</a></li>
                <li><a href="architecture.html">Architecture</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Data Collection</div>
            <ul class="sidebar-nav">
                <li><a href="data-connectors.html">Data Connectors</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Detection & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="analytics-rules.html" class="active">Analytics Rules</a></li>
                <li><a href="connector-rules.html">Connector Rules</a></li>
                <li><a href="correlation-rules.html">Correlation Rules</a></li>
                <li><a href="kql-library.html">KQL Library</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Investigation & Response</div>
            <ul class="sidebar-nav">
                <li><a href="incidents.html">Incidents</a></li>
                <li><a href="automation.html">Automation & SOAR</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Intelligence & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="workbooks.html">Workbooks</a></li>
                <li><a href="threat-intelligence.html">Threat Intelligence</a></li>
                <li><a href="ueba.html">UEBA</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Management</div>
            <ul class="sidebar-nav">
                <li><a href="content-hub.html">Content Hub</a></li>
                <li><a href="costs.html">Pricing & Costs</a></li>
                <li><a href="best-practices.html">Best Practices</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Quick Resources</div>
            <ul class="sidebar-nav">
                <li><a href="kql-cheatsheet.html">KQL Cheat Sheet</a></li>
                <li><a href="deployment-checklist.html">Deployment Checklist</a></li>
                <li><a href="interview-prep.html">Interview Prep</a></li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <h1>Analytics Rules</h1>
            <p>Analytics rules are the detection engine of Microsoft Sentinel. They query ingested data to identify threats, generate alerts, and create incidents for investigation. This guide covers all rule types, entity mapping, MITRE alignment, and tuning strategies.</p>

            <!-- Table of Contents -->
            <div class="toc">
                <div class="toc-title">On This Page</div>
                <ul class="toc-list">
                    <li><a href="#overview">Rule Types Overview</a></li>
                    <li><a href="#scheduled">Scheduled Rules</a></li>
                    <li><a href="#nrt">NRT (Near Real-Time) Rules</a></li>
                    <li><a href="#fusion">Fusion Rules</a></li>
                    <li><a href="#microsoft">Microsoft Security Rules</a></li>
                    <li><a href="#ml">ML Behavior Analytics</a></li>
                    <li><a href="#entity">Entity Mapping</a></li>
                    <li><a href="#mitre">MITRE ATT&CK Mapping</a></li>
                    <li><a href="#tuning">Tuning & False Positives</a></li>
                </ul>
            </div>

            <!-- Rule Types Overview -->
            <h2 id="overview">Rule Types Overview</h2>
            <p>Microsoft Sentinel offers multiple rule types, each optimized for different detection scenarios. Choose the appropriate type based on latency requirements, data sources, and detection logic complexity.</p>

            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           ANALYTICS RULE TYPES                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         SCHEDULED RULES                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  • Custom KQL queries                                                │   │   │
│   │   │  • Run frequency: 5 min to 14 days                                   │   │   │
│   │   │  • Lookback: 5 min to 14 days                                        │   │   │
│   │   │  • Most flexible, most common                                        │   │   │
│   │   │  • Full KQL capabilities                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         NRT (NEAR REAL-TIME) RULES                           │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  • Sub-minute detection latency                                      │   │   │
│   │   │  • Limited KQL (no joins, aggregations, time lookback)               │   │   │
│   │   │  • Best for high-priority, simple detections                         │   │   │
│   │   │  • Event-driven (processes each event as it arrives)                 │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         FUSION RULES (ML-BASED)                              │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  • Microsoft-managed ML models                                       │   │   │
│   │   │  • Correlates alerts across products                                 │   │   │
│   │   │  • Detects multi-stage attacks automatically                         │   │   │
│   │   │  • Cannot be customized (enable/disable only)                        │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      MICROSOFT SECURITY RULES                                │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  • Import alerts from other Microsoft security products              │   │   │
│   │   │  • MDE, MDI, MDO, MCAS, Defender for Cloud                           │   │   │
│   │   │  • Automatic incident creation from product alerts                   │   │   │
│   │   │  • Configurable severity filtering                                   │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      ML BEHAVIOR ANALYTICS                                   │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  • Anomaly detection based on baselines                              │   │   │
│   │   │  • User and entity behavior analytics                                │   │   │
│   │   │  • Requires UEBA enabled                                             │   │   │
│   │   │  • Configurable thresholds                                           │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      THREAT INTELLIGENCE RULES                               │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  • Match logs against TI indicators                                  │   │   │
│   │   │  • IP, domain, URL, file hash matching                               │   │   │
│   │   │  • Requires TI connector enabled                                     │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Rule Type</th>
                            <th>Latency</th>
                            <th>Customization</th>
                            <th>Best For</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Scheduled</td>
                            <td>5 min - 14 days</td>
                            <td>Full KQL</td>
                            <td>Complex detections, aggregations, correlations</td>
                        </tr>
                        <tr>
                            <td>NRT</td>
                            <td>&lt;1 minute</td>
                            <td>Limited KQL</td>
                            <td>High-priority, simple pattern matching</td>
                        </tr>
                        <tr>
                            <td>Fusion</td>
                            <td>Minutes</td>
                            <td>None (managed)</td>
                            <td>Multi-stage attack detection</td>
                        </tr>
                        <tr>
                            <td>Microsoft Security</td>
                            <td>Near real-time</td>
                            <td>Filter by severity</td>
                            <td>Importing Defender product alerts</td>
                        </tr>
                        <tr>
                            <td>ML Behavior</td>
                            <td>Hours</td>
                            <td>Thresholds</td>
                            <td>Anomaly detection, unusual behavior</td>
                        </tr>
                        <tr>
                            <td>Threat Intelligence</td>
                            <td>Minutes</td>
                            <td>IOC types</td>
                            <td>Known bad indicators</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Scheduled Rules -->
            <h2 id="scheduled">Scheduled Rules</h2>
            <p>Scheduled rules are the most versatile rule type, supporting full KQL queries with aggregations, joins, and time-based analysis. They run on a configurable schedule and look back at historical data.</p>

            <h3>Rule Creation Wizard</h3>
            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    SCHEDULED RULE CREATION WIZARD                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  STEP 1: General                                                                 │
│  ───────────────                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Name:        [Brute Force Attack on Azure AD]                              │ │
│  │  Description: [Detects multiple failed logins followed by success...]       │ │
│  │  Severity:    [High ▼]                                                      │ │
│  │  MITRE:       [Credential Access > Brute Force (T1110)]                     │ │
│  │  Status:      [Enabled ●]                                                   │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  STEP 2: Set Rule Logic                                                         │
│  ──────────────────────                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Rule Query (KQL):                                                          │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │ │
│  │  │  let threshold = 10;                                                  │  │ │
│  │  │  let timeframe = 5m;                                                  │  │ │
│  │  │  SigninLogs                                                           │  │ │
│  │  │  | where TimeGenerated > ago(timeframe)                               │  │ │
│  │  │  | where ResultType == "50126" // Invalid password                    │  │ │
│  │  │  | summarize FailedCount = count() by UserPrincipalName, IPAddress    │  │ │
│  │  │  | where FailedCount >= threshold                                     │  │ │
│  │  └──────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                             │ │
│  │  Query Scheduling:                                                          │ │
│  │  • Run query every: [5 minutes ▼]                                           │ │
│  │  • Lookup data from: [Last 5 minutes ▼]                                     │ │
│  │                                                                             │ │
│  │  Alert Threshold:                                                           │ │
│  │  • Generate alert when: [Number of query results is greater than 0]         │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  STEP 3: Entity Mapping                                                         │
│  ──────────────────────                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Account  →  UserPrincipalName                                              │ │
│  │  IP       →  IPAddress                                                      │ │
│  │  Host     →  (not mapped)                                                   │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  STEP 4: Incident Settings                                                      │
│  ─────────────────────────                                                       │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Create incidents: [Enabled ●]                                              │ │
│  │  Alert grouping:   [Group alerts into single incident by: Entity]          │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  STEP 5: Automated Response                                                     │
│  ──────────────────────────                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Automation rules:  [Block-User-Playbook]                                   │ │
│  │  Playbooks:         [Send-Teams-Notification]                               │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <h3>Example: Brute Force Detection Rule</h3>
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Brute Force Attack Against Azure AD</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1110</span>
                        <span class="tag">Credential Access</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects multiple failed login attempts from the same IP address within a short time window, indicating potential brute force or password spray attack.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Data Connector Required</div>
                        <p>Azure Active Directory (SigninLogs)</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let failureThreshold = 10;
let successThreshold = 1;
let timeWindow = 10m;
// Get failed logins
let failedLogins = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType != "0" // Non-successful
| where ResultType in ("50126", "50074", "50076", "53003") // Password/MFA failures
| summarize 
    FailedCount = count(),
    FailedUsers = make_set(UserPrincipalName),
    FirstFailed = min(TimeGenerated),
    LastFailed = max(TimeGenerated)
    by IPAddress, Location, AppDisplayName;
// Get successful logins from same IPs
let successfulLogins = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType == "0"
| summarize 
    SuccessCount = count(),
    SuccessUsers = make_set(UserPrincipalName)
    by IPAddress;
// Correlate
failedLogins
| where FailedCount >= failureThreshold
| join kind=leftouter successfulLogins on IPAddress
| extend SuccessAfterFail = iff(isnotempty(SuccessCount), true, false)
| project 
    TimeGenerated = LastFailed,
    IPAddress,
    Location,
    FailedCount,
    FailedUsers,
    SuccessAfterFail,
    SuccessUsers,
    AppDisplayName</pre>
                            </div>
                        </div>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Entity Mapping</div>
                        <ul>
                            <li><strong>IP:</strong> IPAddress</li>
                            <li><strong>Account:</strong> FailedUsers (array)</li>
                        </ul>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Scheduling</div>
                        <p>Run every 5 minutes, lookback 10 minutes</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Known False Positives</div>
                        <ul>
                            <li>Users with cached incorrect passwords</li>
                            <li>Legacy apps with authentication issues</li>
                            <li>Service accounts with expired credentials</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- NRT Rules -->
            <h2 id="nrt">NRT (Near Real-Time) Rules</h2>
            <p>NRT rules provide sub-minute detection latency by processing events as they arrive. They have KQL limitations but are ideal for high-priority, simple pattern matching.</p>

            <div class="alert alert-warning">
                <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div class="alert-content">
                    <div class="alert-title">NRT Limitations</div>
                    <p class="alert-text">NRT rules cannot use: joins, union (with wildcards), external data, time functions (ago, now), aggregations across events, nested queries. Each event is processed independently.</p>
                </div>
            </div>

            <h3>Example: NRT Rule - Mimikatz Execution</h3>
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Mimikatz Command Line Detection (NRT)</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1003</span>
                        <span class="tag">NRT</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// NRT Rule - No joins or aggregations
DeviceProcessEvents
| where ProcessCommandLine has_any (
    "sekurlsa::logonpasswords",
    "sekurlsa::wdigest",
    "lsadump::dcsync",
    "lsadump::lsa",
    "privilege::debug",
    "token::elevate",
    "kerberos::golden"
)
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    FileName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fusion Rules -->
            <h2 id="fusion">Fusion Rules</h2>
            <p>Fusion uses Microsoft's ML models to automatically correlate alerts from multiple sources and detect multi-stage attacks. It cannot be customized—only enabled or disabled.</p>

            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           FUSION DETECTION ENGINE                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   INPUT SIGNALS                          FUSION ML                 OUTPUT        │
│   ─────────────                          ─────────                 ──────        │
│                                                                                  │
│   ┌─────────────┐                                                               │
│   │  MDE Alerts │──┐                                                            │
│   └─────────────┘  │                                                            │
│                    │     ┌───────────────────────────┐                          │
│   ┌─────────────┐  │     │                           │     ┌─────────────────┐  │
│   │  MDI Alerts │──┼────▶│   MACHINE LEARNING        │────▶│  HIGH-FIDELITY  │  │
│   └─────────────┘  │     │   CORRELATION ENGINE      │     │   INCIDENTS     │  │
│                    │     │                           │     │                 │  │
│   ┌─────────────┐  │     │   • Pattern matching      │     │  • Ransomware   │  │
│   │  AAD Logs   │──┼────▶│   • Kill chain detection  │     │  • Exfiltration │  │
│   └─────────────┘  │     │   • Anomaly correlation   │     │  • Lateral Move │  │
│                    │     │                           │     │                 │  │
│   ┌─────────────┐  │     └───────────────────────────┘     └─────────────────┘  │
│   │  Firewall   │──┘                                                            │
│   └─────────────┘                                                               │
│                                                                                  │
│   FUSION DETECTION SCENARIOS:                                                    │
│   ───────────────────────────                                                    │
│   • Suspicious sign-in → Malware execution → Data exfiltration                  │
│   • Credential theft → Lateral movement → Privilege escalation                  │
│   • Phishing → Malicious link click → Payload execution                         │
│   • Impossible travel → Sensitive data access → Mass download                   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <h3>Fusion Attack Scenarios</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Data Sources</th>
                            <th>Kill Chain Stages</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ransomware Deployment</td>
                            <td>MDE, Azure AD, Firewall</td>
                            <td>Initial Access → Execution → Impact</td>
                        </tr>
                        <tr>
                            <td>Data Exfiltration</td>
                            <td>MDE, MCAS, Azure AD</td>
                            <td>Credential Access → Collection → Exfiltration</td>
                        </tr>
                        <tr>
                            <td>Crypto Mining</td>
                            <td>MDE, Azure Activity, Firewall</td>
                            <td>Execution → C2 → Resource Hijacking</td>
                        </tr>
                        <tr>
                            <td>Privilege Escalation Path</td>
                            <td>MDI, Azure AD, MDE</td>
                            <td>Reconnaissance → Privilege Escalation → Lateral Movement</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Microsoft Security Rules -->
            <h2 id="microsoft">Microsoft Security Rules</h2>
            <p>Microsoft Security rules automatically create incidents from alerts generated by other Microsoft security products. They're configured with severity filters and cannot contain custom KQL.</p>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Configuration Example</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>Microsoft Security Alert Rule Configuration:

Name: Create incidents from Defender for Endpoint alerts
Source: Microsoft Defender for Endpoint

Severity Filters:
  ☑ High
  ☑ Medium
  ☐ Low
  ☐ Informational

Alert Name Filters:
  Include: (all) 
  Exclude: "Test alert", "Unwanted application"

Note: For granular filtering, use Automation Rules instead</pre>
                </div>
            </div>

            <!-- Entity Mapping -->
            <h2 id="entity">Entity Mapping</h2>
            <p>Entity mapping links query results to Sentinel entity types, enabling investigation graph visualization, UEBA correlation, and automated entity enrichment.</p>

            <h3>Supported Entity Types</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Entity Type</th>
                            <th>Required Fields</th>
                            <th>Optional Fields</th>
                            <th>Use Case</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Account</strong></td>
                            <td>Name OR FullName OR UPNSuffix</td>
                            <td>Sid, AadTenantId, AadUserId, ObjectGuid</td>
                            <td>User accounts, service accounts</td>
                        </tr>
                        <tr>
                            <td><strong>Host</strong></td>
                            <td>HostName OR FullName</td>
                            <td>DnsDomain, NTDomain, AzureID, OSFamily</td>
                            <td>Servers, workstations, devices</td>
                        </tr>
                        <tr>
                            <td><strong>IP</strong></td>
                            <td>Address</td>
                            <td>—</td>
                            <td>Source/destination IP addresses</td>
                        </tr>
                        <tr>
                            <td><strong>URL</strong></td>
                            <td>Url</td>
                            <td>—</td>
                            <td>Malicious URLs, phishing links</td>
                        </tr>
                        <tr>
                            <td><strong>File</strong></td>
                            <td>Name</td>
                            <td>Directory, FileHashes</td>
                            <td>Malware files, suspicious executables</td>
                        </tr>
                        <tr>
                            <td><strong>Process</strong></td>
                            <td>CommandLine OR ProcessId</td>
                            <td>ElevationToken, CreationTimeUtc</td>
                            <td>Malicious processes</td>
                        </tr>
                        <tr>
                            <td><strong>FileHash</strong></td>
                            <td>Algorithm, Value</td>
                            <td>—</td>
                            <td>MD5, SHA1, SHA256 hashes</td>
                        </tr>
                        <tr>
                            <td><strong>RegistryKey</strong></td>
                            <td>Hive, Key</td>
                            <td>—</td>
                            <td>Persistence mechanisms</td>
                        </tr>
                        <tr>
                            <td><strong>Mailbox</strong></td>
                            <td>MailboxPrimaryAddress</td>
                            <td>DisplayName, Upn</td>
                            <td>Email-based attacks</td>
                        </tr>
                        <tr>
                            <td><strong>CloudApplication</strong></td>
                            <td>AppId OR Name</td>
                            <td>InstanceName</td>
                            <td>Cloud app events</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Entity Mapping Example</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL with Entity Mapping Comments</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>DeviceProcessEvents
| where FileName has "powershell.exe"
| where ProcessCommandLine has_any ("Invoke-WebRequest", "DownloadString", "IEX")
| project 
    TimeGenerated,
    // Entity: Host (map to HostName)
    DeviceName,
    // Entity: Account (map to Name)
    AccountName,
    // Entity: Account (map to Sid)  
    AccountSid,
    // Entity: Process (map to CommandLine)
    ProcessCommandLine,
    // Entity: File (map to Name)
    FileName,
    // Entity: File (map to Directory)
    FolderPath,
    // Entity: Process (map to ProcessId)
    ProcessId,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine

// Entity Mapping Configuration in UI:
// ─────────────────────────────────────
// Entity Type: Host
//   Identifier: HostName = DeviceName
//
// Entity Type: Account  
//   Identifier: Name = AccountName
//   Identifier: Sid = AccountSid
//
// Entity Type: Process
//   Identifier: CommandLine = ProcessCommandLine
//   Identifier: ProcessId = ProcessId
//
// Entity Type: File
//   Identifier: Name = FileName
//   Identifier: Directory = FolderPath</pre>
                </div>
            </div>

            <!-- MITRE ATT&CK -->
            <h2 id="mitre">MITRE ATT&CK Mapping</h2>
            <p>Map analytics rules to MITRE ATT&CK tactics and techniques for coverage analysis, gap identification, and standardized threat communication.</p>

            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              MITRE ATT&CK ENTERPRISE MATRIX                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  RECONNAISSANCE   RESOURCE    INITIAL     EXECUTION   PERSISTENCE   PRIVILEGE          │
│                   DEVELOPMENT ACCESS                                 ESCALATION         │
│  ├─ T1595          ├─ T1583    ├─ T1566    ├─ T1059    ├─ T1547      ├─ T1548           │
│  │  Active Scan    │  Domains  │  Phishing │  Scripts  │  Boot/Logon │  Abuse Elevation │
│  ├─ T1592          ├─ T1584    ├─ T1190    ├─ T1204    ├─ T1136      ├─ T1134           │
│  │  Gather Info    │  Infra    │  Exploit  │  User Exe │  Create Acc │  Access Token    │
│  └─ T1589          └─ T1587    ├─ T1133    ├─ T1053    ├─ T1543      └─ T1068           │
│     Employee Info     Malware  │  External │  Scheduled│  Create Svc    Exploitation    │
│                                │  Services │  Task     │                                │
│                                └─ T1078    └─ T1569    └─ T1098                         │
│                                   Valid      System      Account                        │
│                                   Accounts   Services    Modification                   │
│                                                                                          │
│  DEFENSE          CREDENTIAL  DISCOVERY   LATERAL     COLLECTION   EXFILTRATION        │
│  EVASION          ACCESS                  MOVEMENT                                       │
│  ├─ T1562          ├─ T1110    ├─ T1087    ├─ T1021    ├─ T1560      ├─ T1041           │
│  │  Impair Defense │  Brute    │  Account  │  Remote   │  Archive    │  C2 Channel      │
│  ├─ T1070          ├─ T1003    ├─ T1082    ├─ T1570    ├─ T1005      ├─ T1048           │
│  │  Clear Logs     │  Cred Dump│  System   │  Lateral  │  Local Data │  Alt Protocol    │
│  ├─ T1036          ├─ T1558    ├─ T1046    ├─ T1210    ├─ T1114      └─ T1567           │
│  │  Masquerading   │  Kerberos │  Network  │  Exploit  │  Email         Exfil Web Svc  │
│  └─ T1027          └─ T1552    │  Scan     │  Remote   │  Collection                    │
│     Obfuscation       Unsec Crd└─ T1018    └─ T1563    └─ T1213                         │
│                                   Remote      RDP         Data from                     │
│                                   System      Hijacking   Repos                         │
│                                                                                          │
│  COMMAND AND CONTROL                                    IMPACT                          │
│  ├─ T1071 Application Layer Protocol                   ├─ T1486 Data Encrypted         │
│  ├─ T1095 Non-Application Layer Protocol               ├─ T1490 Inhibit Recovery       │
│  ├─ T1572 Protocol Tunneling                           ├─ T1489 Service Stop           │
│  └─ T1090 Proxy                                        └─ T1529 System Shutdown        │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <!-- Tuning -->
            <h2 id="tuning">Tuning & False Positive Reduction</h2>
            <p>Effective rule tuning reduces alert fatigue and improves SOC efficiency. Use these strategies to minimize false positives while maintaining detection coverage.</p>

            <h3>Tuning Strategies</h3>
            <div class="accordion">
                <div class="accordion-item">
                    <button class="accordion-header">
                        1. Exclusion Lists (Watchlists)
                        <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    <div class="accordion-content">
                        <p>Create watchlists for known-good entities and exclude them from rules:</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let allowedIPs = _GetWatchlist('AllowedIPs') | project IPAddress;
let allowedUsers = _GetWatchlist('ServiceAccounts') | project UserPrincipalName;
SigninLogs
| where IPAddress !in (allowedIPs)
| where UserPrincipalName !in (allowedUsers)
| where ResultType != "0"
// Continue with detection logic...</pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <button class="accordion-header">
                        2. Threshold Tuning
                        <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    <div class="accordion-content">
                        <p>Adjust thresholds based on environment baseline:</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Calculate baseline for tuning
SecurityEvent
| where EventID == 4625
| where TimeGenerated > ago(30d)
| summarize FailedLogins = count() by bin(TimeGenerated, 1h)
| summarize 
    AvgHourly = avg(FailedLogins),
    StdDev = stdev(FailedLogins),
    P95 = percentile(FailedLogins, 95),
    P99 = percentile(FailedLogins, 99)

// Set threshold at P95 or P99 based on risk tolerance</pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <button class="accordion-header">
                        3. Time-Based Exclusions
                        <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    <div class="accordion-content">
                        <p>Exclude known maintenance windows or scheduled activities:</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>// Exclude maintenance window (Saturdays 2-6 AM UTC)
| where not(
    dayofweek(TimeGenerated) == 6 
    and hourofday(TimeGenerated) between (2 .. 6)
)
// Exclude patch Tuesday activities
| where not(
    dayofweek(TimeGenerated) == 2 
    and dayofmonth(TimeGenerated) between (8 .. 14)
)</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                </svg>
                <div class="alert-content">
                    <div class="alert-title">Rule Validation</div>
                    <p class="alert-text">Always test rules in a non-production environment first. Use the "Test with current data" feature in the rule wizard to validate query results before enabling.</p>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="footer-content">
                    <svg class="footer-icon" viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    Microsoft Sentinel Ultimate Guide
                </div>
            </footer>
        </div>
    </main>

    <script src="main.js"></script>
</body>
</html>
