<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Microsoft Sentinel Watchlists and Threat Intelligence - Managing IOC lists, threat feeds, and enrichment.">
    <title>Watchlists & Threat Intel | SIEM Mastery Guide</title>
    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
</head>
<body>
    <div class="page-wrapper">
        <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
            <div class="hamburger"><span></span><span></span><span></span></div>
        </button>
        <div class="sidebar-overlay"></div>
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">
                    <div class="logo-icon">ğŸ›¡ï¸</div>
                    <div>
                        <div class="logo-text">SIEM Mastery</div>
                        <div class="logo-subtext">Documentation</div>
                    </div>
                </a>
            </div>
            
                        <nav class="sidebar-nav">
                <!-- Section 1: SIEM Fundamentals -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ“š</span>
                            <span>SIEM Fundamentals</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="1-1-introduction-to-siem.html" class="nav-item">1.1 Introduction to SIEM</a>
                        <a href="1-2-architecture-components.html" class="nav-item">1.2 Architecture & Components</a>
                        <a href="1-3-log-sources-onboarding.html" class="nav-item">1.3 Log Sources & Onboarding</a>
                        <a href="1-4-log-parsing-normalization.html" class="nav-item">1.4 Log Parsing & Normalization</a>
                        <a href="1-5-detection-engineering-fundamentals.html" class="nav-item">1.5 Detection Engineering</a>
                        <a href="1-6-soc-operations-siem.html" class="nav-item">1.6 SOC Operations & SIEM</a>
                    </div>
                </div>
                
                <!-- Section 2: Splunk Fundamentals -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸŸ¢</span>
                            <span>Splunk Fundamentals</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="2-1-splunk-architecture.html" class="nav-item">2.1 Splunk Architecture</a>
                        <a href="2-2-installation-configuration.html" class="nav-item">2.2 Installation & Configuration</a>
                        <a href="2-3-data-ingestion.html" class="nav-item">2.3 Data Ingestion</a>
                        <a href="2-4-index-management.html" class="nav-item">2.4 Index Management</a>
                        <a href="2-5-spl-fundamentals.html" class="nav-item">2.5 SPL Fundamentals</a>
                        <a href="2-6-spl-data-retrieval.html" class="nav-item">2.6 SPL Data Retrieval</a>
                        <a href="2-7-spl-transforming.html" class="nav-item">2.7 SPL Transforming</a>
                        <a href="2-8-spl-manipulation.html" class="nav-item">2.8 SPL Manipulation</a>
                        <a href="2-9-spl-advanced.html" class="nav-item">2.9 SPL Advanced</a>
                        <a href="2-10-search-optimization.html" class="nav-item">2.10 Search Optimization</a>
                    </div>
                </div>
                
                <!-- Section 3: Splunk Security Operations -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”’</span>
                            <span>Splunk Security Ops</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="3-1-splunk-es-overview.html" class="nav-item">3.1 Enterprise Security Overview</a>
                        <a href="3-2-notable-events.html" class="nav-item">3.2 Notable Events</a>
                        <a href="3-3-correlation-searches.html" class="nav-item">3.3 Correlation Searches</a>
                        <a href="3-4-risk-based-alerting.html" class="nav-item">3.4 Risk-Based Alerting</a>
                        <a href="3-5-threat-intelligence.html" class="nav-item">3.5 Threat Intelligence</a>
                        <a href="3-6-asset-identity.html" class="nav-item">3.6 Asset & Identity</a>
                        <a href="3-7-security-dashboards.html" class="nav-item">3.7 Security Dashboards</a>
                        <a href="3-8-es-administration.html" class="nav-item">3.8 ES Administration</a>
                    </div>
                </div>
                
                <!-- Section 4: Splunk SOAR -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">âš¡</span>
                            <span>Splunk SOAR</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="4-1-soar-overview.html" class="nav-item">4.1 SOAR Overview</a>
                        <a href="4-2-playbooks.html" class="nav-item">4.2 Playbooks</a>
                        <a href="4-3-apps-integrations.html" class="nav-item">4.3 Apps & Integrations</a>
                        <a href="4-4-case-management.html" class="nav-item">4.4 Case Management</a>
                    </div>
                </div>
                
                <!-- Section 5: Microsoft Sentinel Fundamentals -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”·</span>
                            <span>Sentinel Fundamentals</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="5-1-sentinel-architecture.html" class="nav-item">5.1 Sentinel Architecture</a>
                        <a href="5-2-log-analytics.html" class="nav-item">5.2 Log Analytics Workspace</a>
                        <a href="5-3-data-connectors.html" class="nav-item">5.3 Data Connectors</a>
                        <a href="5-4-kql-fundamentals.html" class="nav-item">5.4 KQL Fundamentals</a>
                        <a href="5-5-kql-advanced.html" class="nav-item">5.5 KQL Advanced</a>
                        <a href="5-6-analytics-rules.html" class="nav-item">5.6 Analytics Rules</a>
                        <a href="5-7-incidents-investigation.html" class="nav-item">5.7 Incidents & Investigation</a>
                        <a href="5-8-workbooks-reporting.html" class="nav-item">5.8 Workbooks & Reporting</a>
                    </div>
                </div>
                
                <!-- Section 6: Sentinel Security Operations -->
                <div class="nav-section expanded">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”¶</span>
                            <span>Sentinel Security Ops</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="6-1-automation-playbooks.html" class="nav-item">6.1 Automation & Playbooks</a>
                        <a href="6-2-watchlists-ti.html" class="nav-item active">6.2 Watchlists & Threat Intel</a>
                        <a href="6-3-ueba.html" class="nav-item">6.3 UEBA</a>
                        <a href="6-4-sentinel-administration.html" class="nav-item">6.4 Sentinel Administration</a>
                    </div>
                </div>
                
                <!-- Section 7: SIEM Comparison -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”€</span>
                            <span>SIEM Comparison</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="7-1-splunk-vs-sentinel.html" class="nav-item">7.1 Splunk vs Sentinel</a>
                        <a href="7-2-query-language-comparison.html" class="nav-item">7.2 SPL vs KQL</a>
                        <a href="7-3-migration-considerations.html" class="nav-item">7.3 Migration Guide</a>
                    </div>
                </div>
                
                <!-- Section 8: Detection Engineering -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ¯</span>
                            <span>Detection Engineering</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="8-1-detection-development.html" class="nav-item">8.1 Detection Development</a>
                        <a href="8-2-mitre-attack.html" class="nav-item">8.2 MITRE ATT&CK</a>
                        <a href="8-3-sigma-rules.html" class="nav-item">8.3 SIGMA Rules</a>
                        <a href="8-4-detection-testing.html" class="nav-item">8.4 Testing & Validation</a>
                    </div>
                </div>
                
                <!-- Section 9: Threat Hunting -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”</span>
                            <span>Threat Hunting</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="9-1-hunting-fundamentals.html" class="nav-item">9.1 Hunting Fundamentals</a>
                        <a href="9-2-hunting-methodologies.html" class="nav-item">9.2 Hunting Methodologies</a>
                        <a href="9-3-hunting-queries.html" class="nav-item">9.3 Hunting Queries</a>
                    </div>
                </div>
                
                <!-- Section 10: Use Case Library -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ“</span>
                            <span>Use Case Library</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="10-1-authentication-attacks.html" class="nav-item">10.1 Authentication Attacks</a>
                        <a href="10-2-malware-execution.html" class="nav-item">10.2 Malware & Execution</a>
                        <a href="10-3-data-exfiltration.html" class="nav-item">10.3 Data Exfiltration</a>
                        <a href="10-4-insider-threats.html" class="nav-item">10.4 Insider Threats</a>
                    </div>
                </div>
                <!-- Appendices -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ“–</span>
                            <span>Appendices</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="a-1-windows-security-fundamentals.html" class="nav-item">A.1 Windows Security</a>
                        <a href="a-2-network-fundamentals.html" class="nav-item">A.2 Network Fundamentals</a>
                        <a href="a-3-use-case-development.html" class="nav-item">A.3 Use Case Development</a>
                        <a href="a-4-siem-migration-guide.html" class="nav-item">A.4 SIEM Migration Guide</a>
                        <a href="a-5-siem-design-from-scratch.html" class="nav-item">A.5 Design from Scratch</a>
                    </div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <p>Built for Security Engineers</p>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="content-header">
                <nav class="breadcrumb">
                    <a href="index.html">Home</a>
                    <span class="breadcrumb-separator">/</span>
                    <a href="6-1-automation-playbooks.html">Sentinel Security Ops</a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">Watchlists & Threat Intel</span>
                </nav>
            </header>
            
            <div class="content-area">
                <h1 class="page-title">Watchlists & Threat Intelligence</h1>
                <p class="page-subtitle">Managing custom lists and threat feeds for detection and enrichment</p>
                
                <div class="info-box overview">
                    <div class="info-box-header">
                        <span class="info-box-icon">ğŸ“˜</span>
                        Chapter Overview
                    </div>
                    <div class="info-box-content">
                        <p>
                            Watchlists and Threat Intelligence enhance Sentinel's detection capabilities. Watchlists store custom data for use in queries and rules, while Threat Intelligence provides IOCs from external feeds. This chapter covers creating and using both features.
                        </p>
                    </div>
                </div>
                
                <h2 id="watchlists">Watchlists</h2>
                
                <pre><code class="language-text">WATCHLIST USE CASES:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ALLOWLISTS                                              â”‚
â”‚ â€¢ Approved IPs (VPN, corporate egress)                 â”‚
â”‚ â€¢ Approved applications                                â”‚
â”‚ â€¢ Known service accounts                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BLOCKLISTS                                              â”‚
â”‚ â€¢ Known malicious IPs/domains                          â”‚
â”‚ â€¢ Prohibited applications                              â”‚
â”‚ â€¢ Terminated user accounts                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENRICHMENT                                              â”‚
â”‚ â€¢ Asset inventory                                      â”‚
â”‚ â€¢ User metadata (department, VIP status)               â”‚
â”‚ â€¢ Business context                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
                
                <h3>Creating a Watchlist</h3>
                
                <pre><code class="language-text">CREATING WATCHLIST:

Sentinel â†’ Watchlist â†’ Add new

CONFIGURATION:
â€¢ Name: VIP_Users
â€¢ Alias: vip_users (used in queries)
â€¢ Description: Executive and high-value users
â€¢ Source: Local file (CSV)
â€¢ Search key: UserPrincipalName

CSV FORMAT:
UserPrincipalName,Department,VIPLevel
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a1c2c4cee1c2ceccd1c0cfd88fc2cecc">[email&#160;protected]</a>,Executive,Critical
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7112171e31121e1c01101f085f121e1c">[email&#160;protected]</a>,Executive,Critical
<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="690a001a06290a060419080710470a0604">[email&#160;protected]</a>,Security,High</code></pre>
                
                <h3>Using Watchlists in KQL</h3>
                
                <pre><code class="language-kql">// Get watchlist data
_GetWatchlist('vip_users')

// Join with sign-in logs
SigninLogs
| where TimeGenerated > ago(24h)
| join kind=inner (
    _GetWatchlist('vip_users')
    | project UserPrincipalName, VIPLevel
) on UserPrincipalName
| where ResultType != 0

// Use in where clause
let VIPUsers = _GetWatchlist('vip_users') | project UserPrincipalName;
SigninLogs
| where TimeGenerated > ago(24h)
| where UserPrincipalName in (VIPUsers)

// Exclude allowlisted IPs
let AllowedIPs = _GetWatchlist('allowed_ips') | project IPAddress;
SigninLogs
| where TimeGenerated > ago(1h)
| where IPAddress !in (AllowedIPs)
| where ResultType != 0</code></pre>
                
                <h3>Common Watchlists</h3>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Watchlist</th>
                                <th>Content</th>
                                <th>Use Case</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>VIP_Users</strong></td>
                                <td>Executives, privileged users</td>
                                <td>Higher severity for VIP alerts</td>
                            </tr>
                            <tr>
                                <td><strong>Service_Accounts</strong></td>
                                <td>Known service account UPNs</td>
                                <td>Exclude from user-based detections</td>
                            </tr>
                            <tr>
                                <td><strong>Approved_IPs</strong></td>
                                <td>Corporate IPs, VPN ranges</td>
                                <td>Exclude from external access alerts</td>
                            </tr>
                            <tr>
                                <td><strong>High_Value_Assets</strong></td>
                                <td>Critical servers, databases</td>
                                <td>Increase severity for asset alerts</td>
                            </tr>
                            <tr>
                                <td><strong>Terminated_Users</strong></td>
                                <td>Recently terminated accounts</td>
                                <td>Alert on any activity</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h2 id="threat-intelligence">Threat Intelligence</h2>
                
                <pre><code class="language-text">THREAT INTELLIGENCE FLOW:

External Feeds                    Sentinel TI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAXII/STIX  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ ThreatIntel â”‚
â”‚ Feeds       â”‚                â”‚ Indicators  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚             â”‚
                               â”‚ â€¢ IP        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â€¢ Domain    â”‚
â”‚ Microsoft   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â€¢ URL       â”‚
â”‚ TI (MDTI)   â”‚                â”‚ â€¢ Hash      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â€¢ Email     â”‚
                               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚ Custom      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º       â”‚
â”‚ Indicators  â”‚                       â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Analytics   â”‚
                              â”‚ Rules Match â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
                
                <h3>Configuring TI Connectors</h3>
                
                <pre><code class="language-text">THREAT INTELLIGENCE CONNECTORS:

1. Microsoft Defender Threat Intelligence (MDTI)
   â€¢ Premium threat intel
   â€¢ Requires license
   â€¢ High-confidence IOCs

2. TAXII Feeds
   â€¢ STIX 2.0/2.1 format
   â€¢ Popular: AlienVault OTX, Anomali
   â€¢ Configure: Server URL, Collection ID, API key

3. Threat Intelligence Platforms
   â€¢ MISP integration
   â€¢ ThreatConnect
   â€¢ Recorded Future

4. Manual Upload
   â€¢ Import CSV/JSON
   â€¢ API upload via Logic App</code></pre>
                
                <h3>TI Indicator Table</h3>
                
                <pre><code class="language-kql">// View threat indicators
ThreatIntelligenceIndicator
| where TimeGenerated > ago(7d)
| where Active == true
| project 
    IndicatorType = ThreatType,
    Value = coalesce(NetworkIP, DomainName, Url, FileHashValue),
    Confidence = ConfidenceScore,
    Source = SourceSystem,
    Description,
    ExpirationDateTime

// Count indicators by type
ThreatIntelligenceIndicator
| where Active == true
| summarize Count = count() by ThreatType
| render piechart

// Check for TI matches
SigninLogs
| where TimeGenerated > ago(24h)
| join kind=inner (
    ThreatIntelligenceIndicator
    | where Active == true
    | where ThreatType == "ip"
    | project TI_IP = NetworkIP, TI_Description = Description
) on $left.IPAddress == $right.TI_IP
| project TimeGenerated, UserPrincipalName, IPAddress, TI_Description</code></pre>
                
                <h3>Built-in TI Analytics Rules</h3>
                
                <pre><code class="language-text">MICROSOFT TI MATCHING RULES:

â€¢ TI map IP entity to AzureActivity
â€¢ TI map IP entity to SigninLogs
â€¢ TI map Domain entity to DNS Events
â€¢ TI map URL entity to Web logs
â€¢ TI map File Hash to Endpoint events
â€¢ TI map Email sender to EmailEvents

ENABLING:
Sentinel â†’ Analytics â†’ Rule templates â†’ Filter: Threat Intelligence
â†’ Create rule from template</code></pre>
                
                <h2 id="ti-matching">Custom TI Matching</h2>
                
                <pre><code class="language-kql">// Custom IP matching rule
let TI_IPs = ThreatIntelligenceIndicator
| where TimeGenerated > ago(30d)
| where Active == true
| where ThreatType == "ip"
| project NetworkIP, Description, Confidence = ConfidenceScore;
SigninLogs
| where TimeGenerated > ago(1h)
| join kind=inner TI_IPs on $left.IPAddress == $right.NetworkIP
| project 
    TimeGenerated,
    UserPrincipalName,
    IPAddress,
    TI_Description = Description,
    TI_Confidence = Confidence

// Domain matching in DNS logs
let TI_Domains = ThreatIntelligenceIndicator
| where Active == true
| where ThreatType == "domain"
| project DomainName;
DnsEvents
| where TimeGenerated > ago(1h)
| where Name in (TI_Domains)
| project TimeGenerated, Computer, ClientIP, Name

// File hash matching
let TI_Hashes = ThreatIntelligenceIndicator
| where Active == true
| where ThreatType == "file"
| project FileHashValue;
DeviceFileEvents
| where TimeGenerated > ago(24h)
| where SHA256 in (TI_Hashes) or SHA1 in (TI_Hashes) or MD5 in (TI_Hashes)
| project TimeGenerated, DeviceName, FileName, FolderPath, SHA256</code></pre>
                
                <h2 id="uploading-indicators">Uploading Custom Indicators</h2>
                
                <pre><code class="language-text">MANUAL UPLOAD:
Sentinel â†’ Threat Intelligence â†’ Add new

FIELDS:
â€¢ Type: ip-addr, domain-name, url, file, email-addr
â€¢ Value: The indicator value
â€¢ Confidence: 0-100
â€¢ Valid from / Valid until
â€¢ Description
â€¢ Threat types: malicious-activity, C2, botnet, etc.
â€¢ Source: Your organization name

BULK UPLOAD VIA API:
POST https://graph.microsoft.com/beta/security/tiIndicators

LOGIC APP INTEGRATION:
â€¢ Trigger: Recurrence (daily)
â€¢ Action: HTTP GET from threat feed
â€¢ Action: Parse JSON
â€¢ Action: For each indicator:
    - Create TI indicator via Graph API</code></pre>
                
                <div class="info-box best-practice">
                    <div class="info-box-header">
                        <span class="info-box-icon">âœ“</span>
                        Watchlist & TI Best Practices
                    </div>
                    <div class="info-box-content">
                        <p>
                            <strong>Watchlists:</strong><br>
                            â–¡ Keep watchlists updated (automate if possible)<br>
                            â–¡ Use meaningful search keys<br>
                            â–¡ Document purpose and owner<br>
                            â–¡ Set expiration for temporary lists<br><br>
                            
                            <strong>Threat Intelligence:</strong><br>
                            â–¡ Use high-confidence feeds<br>
                            â–¡ Set appropriate expiration dates<br>
                            â–¡ Track false positive indicators<br>
                            â–¡ Combine multiple sources for coverage<br>
                            â–¡ Monitor TI matching rule performance
                        </p>
                    </div>
                </div>
                
                <div class="info-box interview">
                    <div class="info-box-header">
                        <span class="info-box-icon">ğŸ’¼</span>
                        Interview Question
                    </div>
                    <div class="info-box-content">
                        <p>
                            <strong>"How would you use watchlists to reduce false positives in Sentinel?"</strong><br><br>
                            <strong>1. Allowlists:</strong> Create watchlists for known-good IPs (corporate egress, VPN), approved service accounts, and trusted applications<br>
                            <strong>2. Modify rules:</strong> Update analytics rules to exclude watchlist entries using <code>!in (_GetWatchlist('name'))</code><br>
                            <strong>3. Automation rules:</strong> Auto-close incidents where entities match watchlist<br>
                            <strong>4. Maintenance:</strong> Keep watchlists current with automation (sync from AD, CMDB)<br>
                            <strong>5. Audit:</strong> Periodically review watchlists to remove stale entries
                        </p>
                    </div>
                </div>
                
                <h2 id="summary">Chapter Summary</h2>
                
                <ul>
                    <li>Watchlists store custom data for queries and rules</li>
                    <li>Use <code>_GetWatchlist('alias')</code> in KQL</li>
                    <li>Common watchlists: VIPs, service accounts, approved IPs</li>
                    <li>Threat Intelligence provides external IOCs</li>
                    <li>TI sources: TAXII/STIX, Microsoft TI, custom upload</li>
                    <li>Built-in rules match TI against common data sources</li>
                </ul>
                
                <div class="page-navigation">
                    <a href="6-1-automation-playbooks.html" class="nav-button prev">
                        <span class="nav-button-icon">â†</span>
                        <div>
                            <span class="nav-button-label">Previous</span>
                            <span class="nav-button-title">Automation & Playbooks</span>
                        </div>
                    </a>
                    <a href="6-3-ueba.html" class="nav-button next">
                        <span class="nav-button-icon">â†’</span>
                        <div>
                            <span class="nav-button-label">Next</span>
                            <span class="nav-button-title">UEBA</span>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
    
    <script src="main.js"></script>
</body>
</html>
