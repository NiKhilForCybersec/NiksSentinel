<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Malware and Execution Use Cases - PowerShell attacks, Living off the Land, and malicious process detection.">
    <title>Malware & Execution | SIEM Mastery Guide</title>
    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
</head>
<body>
    <div class="page-wrapper">
        <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
            <div class="hamburger"><span></span><span></span><span></span></div>
        </button>
        <div class="sidebar-overlay"></div>
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">
                    <div class="logo-icon">ğŸ›¡ï¸</div>
                    <div>
                        <div class="logo-text">SIEM Mastery</div>
                        <div class="logo-subtext">Documentation</div>
                    </div>
                </a>
            </div>
            
                        <nav class="sidebar-nav">
                <!-- Section 1: SIEM Fundamentals -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ“š</span>
                            <span>SIEM Fundamentals</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="1-1-introduction-to-siem.html" class="nav-item">1.1 Introduction to SIEM</a>
                        <a href="1-2-architecture-components.html" class="nav-item">1.2 Architecture & Components</a>
                        <a href="1-3-log-sources-onboarding.html" class="nav-item">1.3 Log Sources & Onboarding</a>
                        <a href="1-4-log-parsing-normalization.html" class="nav-item">1.4 Log Parsing & Normalization</a>
                        <a href="1-5-detection-engineering-fundamentals.html" class="nav-item">1.5 Detection Engineering</a>
                        <a href="1-6-soc-operations-siem.html" class="nav-item">1.6 SOC Operations & SIEM</a>
                    </div>
                </div>
                
                <!-- Section 2: Splunk Fundamentals -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸŸ¢</span>
                            <span>Splunk Fundamentals</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="2-1-splunk-architecture.html" class="nav-item">2.1 Splunk Architecture</a>
                        <a href="2-2-installation-configuration.html" class="nav-item">2.2 Installation & Configuration</a>
                        <a href="2-3-data-ingestion.html" class="nav-item">2.3 Data Ingestion</a>
                        <a href="2-4-index-management.html" class="nav-item">2.4 Index Management</a>
                        <a href="2-5-spl-fundamentals.html" class="nav-item">2.5 SPL Fundamentals</a>
                        <a href="2-6-spl-data-retrieval.html" class="nav-item">2.6 SPL Data Retrieval</a>
                        <a href="2-7-spl-transforming.html" class="nav-item">2.7 SPL Transforming</a>
                        <a href="2-8-spl-manipulation.html" class="nav-item">2.8 SPL Manipulation</a>
                        <a href="2-9-spl-advanced.html" class="nav-item">2.9 SPL Advanced</a>
                        <a href="2-10-search-optimization.html" class="nav-item">2.10 Search Optimization</a>
                    </div>
                </div>
                
                <!-- Section 3: Splunk Security Operations -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”’</span>
                            <span>Splunk Security Ops</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="3-1-splunk-es-overview.html" class="nav-item">3.1 Enterprise Security Overview</a>
                        <a href="3-2-notable-events.html" class="nav-item">3.2 Notable Events</a>
                        <a href="3-3-correlation-searches.html" class="nav-item">3.3 Correlation Searches</a>
                        <a href="3-4-risk-based-alerting.html" class="nav-item">3.4 Risk-Based Alerting</a>
                        <a href="3-5-threat-intelligence.html" class="nav-item">3.5 Threat Intelligence</a>
                        <a href="3-6-asset-identity.html" class="nav-item">3.6 Asset & Identity</a>
                        <a href="3-7-security-dashboards.html" class="nav-item">3.7 Security Dashboards</a>
                        <a href="3-8-es-administration.html" class="nav-item">3.8 ES Administration</a>
                    </div>
                </div>
                
                <!-- Section 4: Splunk SOAR -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">âš¡</span>
                            <span>Splunk SOAR</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="4-1-soar-overview.html" class="nav-item">4.1 SOAR Overview</a>
                        <a href="4-2-playbooks.html" class="nav-item">4.2 Playbooks</a>
                        <a href="4-3-apps-integrations.html" class="nav-item">4.3 Apps & Integrations</a>
                        <a href="4-4-case-management.html" class="nav-item">4.4 Case Management</a>
                    </div>
                </div>
                
                <!-- Section 5: Microsoft Sentinel Fundamentals -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”·</span>
                            <span>Sentinel Fundamentals</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="5-1-sentinel-architecture.html" class="nav-item">5.1 Sentinel Architecture</a>
                        <a href="5-2-log-analytics.html" class="nav-item">5.2 Log Analytics Workspace</a>
                        <a href="5-3-data-connectors.html" class="nav-item">5.3 Data Connectors</a>
                        <a href="5-4-kql-fundamentals.html" class="nav-item">5.4 KQL Fundamentals</a>
                        <a href="5-5-kql-advanced.html" class="nav-item">5.5 KQL Advanced</a>
                        <a href="5-6-analytics-rules.html" class="nav-item">5.6 Analytics Rules</a>
                        <a href="5-7-incidents-investigation.html" class="nav-item">5.7 Incidents & Investigation</a>
                        <a href="5-8-workbooks-reporting.html" class="nav-item">5.8 Workbooks & Reporting</a>
                    </div>
                </div>
                
                <!-- Section 6: Sentinel Security Operations -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”¶</span>
                            <span>Sentinel Security Ops</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="6-1-automation-playbooks.html" class="nav-item">6.1 Automation & Playbooks</a>
                        <a href="6-2-watchlists-ti.html" class="nav-item">6.2 Watchlists & Threat Intel</a>
                        <a href="6-3-ueba.html" class="nav-item">6.3 UEBA</a>
                        <a href="6-4-sentinel-administration.html" class="nav-item">6.4 Sentinel Administration</a>
                    </div>
                </div>
                
                <!-- Section 7: SIEM Comparison -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”€</span>
                            <span>SIEM Comparison</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="7-1-splunk-vs-sentinel.html" class="nav-item">7.1 Splunk vs Sentinel</a>
                        <a href="7-2-query-language-comparison.html" class="nav-item">7.2 SPL vs KQL</a>
                        <a href="7-3-migration-considerations.html" class="nav-item">7.3 Migration Guide</a>
                    </div>
                </div>
                
                <!-- Section 8: Detection Engineering -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ¯</span>
                            <span>Detection Engineering</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="8-1-detection-development.html" class="nav-item">8.1 Detection Development</a>
                        <a href="8-2-mitre-attack.html" class="nav-item">8.2 MITRE ATT&CK</a>
                        <a href="8-3-sigma-rules.html" class="nav-item">8.3 SIGMA Rules</a>
                        <a href="8-4-detection-testing.html" class="nav-item">8.4 Testing & Validation</a>
                    </div>
                </div>
                
                <!-- Section 9: Threat Hunting -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ”</span>
                            <span>Threat Hunting</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="9-1-hunting-fundamentals.html" class="nav-item">9.1 Hunting Fundamentals</a>
                        <a href="9-2-hunting-methodologies.html" class="nav-item">9.2 Hunting Methodologies</a>
                        <a href="9-3-hunting-queries.html" class="nav-item">9.3 Hunting Queries</a>
                    </div>
                </div>
                
                <!-- Section 10: Use Case Library -->
                <div class="nav-section expanded">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ“</span>
                            <span>Use Case Library</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="10-1-authentication-attacks.html" class="nav-item">10.1 Authentication Attacks</a>
                        <a href="10-2-malware-execution.html" class="nav-item active">10.2 Malware & Execution</a>
                        <a href="10-3-data-exfiltration.html" class="nav-item">10.3 Data Exfiltration</a>
                        <a href="10-4-insider-threats.html" class="nav-item">10.4 Insider Threats</a>
                    </div>
                </div>
                <!-- Appendices -->
                <div class="nav-section">
                    <div class="nav-section-header">
                        <span class="nav-section-title">
                            <span class="nav-section-icon">ğŸ“–</span>
                            <span>Appendices</span>
                        </span>
                        <span class="nav-section-arrow">â–¶</span>
                    </div>
                    <div class="nav-section-items">
                        <a href="a-1-windows-security-fundamentals.html" class="nav-item">A.1 Windows Security</a>
                        <a href="a-2-network-fundamentals.html" class="nav-item">A.2 Network Fundamentals</a>
                        <a href="a-3-use-case-development.html" class="nav-item">A.3 Use Case Development</a>
                        <a href="a-4-siem-migration-guide.html" class="nav-item">A.4 SIEM Migration Guide</a>
                        <a href="a-5-siem-design-from-scratch.html" class="nav-item">A.5 Design from Scratch</a>
                    </div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <p>Built for Security Engineers</p>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="content-header">
                <nav class="breadcrumb">
                    <a href="index.html">Home</a>
                    <span class="breadcrumb-separator">/</span>
                    <a href="10-1-authentication-attacks.html">Use Case Library</a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">Malware & Execution</span>
                </nav>
            </header>
            
            <div class="content-area">
                <h1 class="page-title">Malware & Execution Use Cases</h1>
                <p class="page-subtitle">Detection rules for malicious execution, LOLBins, and suspicious processes</p>
                
                <div class="info-box overview">
                    <div class="info-box-header">
                        <span class="info-box-icon">ğŸ“˜</span>
                        Chapter Overview
                    </div>
                    <div class="info-box-content">
                        <p>
                            Modern attackers use "Living off the Land" techniques, leveraging legitimate system tools for malicious purposes. This chapter covers detection of PowerShell attacks, LOLBins abuse, suspicious process chains, and malware indicators.
                        </p>
                    </div>
                </div>
                
                <h2 id="powershell">Use Case: Suspicious PowerShell Execution</h2>
                
                <pre><code class="language-text">USE CASE: MALICIOUS POWERSHELL DETECTION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DESCRIPTION:
Detect PowerShell execution with suspicious characteristics
commonly used by attackers.

MITRE ATT&CK: T1059.001 - Command and Scripting Interpreter

INDICATORS:
â€¢ Encoded commands (-enc, -EncodedCommand)
â€¢ Download cradles (IEX, Invoke-WebRequest, WebClient)
â€¢ Bypass flags (-ep bypass, -executionpolicy bypass)
â€¢ Hidden window (-w hidden, -WindowStyle hidden)
â€¢ No profile (-nop, -NoProfile)</code></pre>
                
                <h3>Sentinel KQL - Encoded Commands</h3>
                
                <pre><code class="language-kql">// PowerShell Encoded Command Execution
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "powershell.exe" or FileName =~ "pwsh.exe"
| where ProcessCommandLine has_any (
    "-enc", "-EncodedCommand", "-e ", "-ec ",
    "FromBase64String", "[Convert]::FromBase64"
)
| project TimeGenerated, DeviceName, AccountName,
    ProcessCommandLine, InitiatingProcessFileName,
    InitiatingProcessCommandLine
| extend CommandLength = strlen(ProcessCommandLine)
| where CommandLength > 200  // Long encoded strings</code></pre>
                
                <h3>Sentinel KQL - Download Cradles</h3>
                
                <pre><code class="language-kql">// PowerShell Download Cradle Detection
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "powershell.exe" or FileName =~ "pwsh.exe"
| where ProcessCommandLine has_any (
    "IEX", "Invoke-Expression",
    "Invoke-WebRequest", "IWR",
    "wget", "curl",
    "Net.WebClient", "DownloadString", "DownloadFile",
    "Start-BitsTransfer",
    "Invoke-RestMethod"
)
| where ProcessCommandLine has_any ("http://", "https://", "ftp://")
| project TimeGenerated, DeviceName, AccountName,
    ProcessCommandLine, InitiatingProcessFileName</code></pre>
                
                <h3>Splunk SPL - Combined Detection</h3>
                
                <pre><code class="language-text">// Suspicious PowerShell - Splunk
index=windows sourcetype=WinEventLog:Security EventCode=4688
| where match(New_Process_Name, "(?i)powershell|pwsh")
| eval suspicious_flags = case(
    match(Process_Command_Line, "(?i)-enc|-encodedcommand"), "Encoded",
    match(Process_Command_Line, "(?i)downloadstring|downloadfile|webclient"), "Download",
    match(Process_Command_Line, "(?i)-ep\s+bypass|-executionpolicy\s+bypass"), "Bypass",
    match(Process_Command_Line, "(?i)-w\s+hidden|-windowstyle\s+hidden"), "Hidden",
    match(Process_Command_Line, "(?i)invoke-expression|iex\s+"), "IEX",
    true(), null()
)
| where isnotnull(suspicious_flags)
| table _time, host, Account_Name, suspicious_flags, Process_Command_Line</code></pre>
                
                <h2 id="lolbins">Use Case: LOLBins Abuse</h2>
                
                <pre><code class="language-text">USE CASE: LIVING OFF THE LAND BINARIES (LOLBins)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DESCRIPTION:
Detect abuse of legitimate Windows binaries for malicious
purposes (execution, download, bypass).

COMMON LOLBins:
â€¢ certutil.exe - Download files, encode/decode
â€¢ mshta.exe - Execute HTA/JavaScript
â€¢ regsvr32.exe - Execute DLLs/scriptlets
â€¢ rundll32.exe - Execute arbitrary code
â€¢ wmic.exe - Process creation, recon
â€¢ msiexec.exe - Execute MSI from URL
â€¢ bitsadmin.exe - Download files</code></pre>
                
                <h3>Sentinel KQL - LOLBins Detection</h3>
                
                <pre><code class="language-kql">// Certutil Suspicious Usage
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "certutil.exe"
| where ProcessCommandLine has_any (
    "-urlcache", "-split", "-f ",
    "-decode", "-encode",
    "http://", "https://"
)
| project TimeGenerated, DeviceName, AccountName,
    ProcessCommandLine, InitiatingProcessFileName

// MSHTA Execution
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "mshta.exe"
| where ProcessCommandLine has_any (
    "javascript:", "vbscript:", "http://", "https://"
)
| project TimeGenerated, DeviceName, AccountName,
    ProcessCommandLine, InitiatingProcessFileName

// Regsvr32 Scriptlet/DLL Execution
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "regsvr32.exe"
| where ProcessCommandLine has_any (
    "/s", "/i:", "scrobj.dll", 
    "http://", "https://"
)
| project TimeGenerated, DeviceName, AccountName,
    ProcessCommandLine

// Combined LOLBins Detection
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName in~ (
    "certutil.exe", "mshta.exe", "regsvr32.exe",
    "wmic.exe", "msiexec.exe", "bitsadmin.exe"
)
| where ProcessCommandLine has_any (
    "http://", "https://", "ftp://",
    "-urlcache", "javascript:", "vbscript:",
    "/transfer", "scrobj"
)
| project TimeGenerated, DeviceName, AccountName,
    LOLBin = FileName, ProcessCommandLine,
    ParentProcess = InitiatingProcessFileName</code></pre>
                
                <h3>Splunk SPL - LOLBins</h3>
                
                <pre><code class="language-text">// LOLBins Detection - Splunk
index=windows sourcetype=WinEventLog:Security EventCode=4688
| where match(New_Process_Name, "(?i)(certutil|mshta|regsvr32|wmic|bitsadmin)\.exe")
| where match(Process_Command_Line, "(?i)(http://|https://|javascript:|vbscript:|urlcache|scrobj)")
| eval LOLBin = mvindex(split(New_Process_Name, "\\"), -1)
| table _time, host, Account_Name, LOLBin, Process_Command_Line, Creator_Process_Name</code></pre>
                
                <h2 id="process-chains">Use Case: Suspicious Process Chains</h2>
                
                <pre><code class="language-text">USE CASE: SUSPICIOUS PARENT-CHILD PROCESSES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DESCRIPTION:
Detect unusual parent-child process relationships that
indicate malicious activity or exploitation.

SUSPICIOUS CHAINS:
â€¢ Office â†’ cmd/powershell (macro execution)
â€¢ Browser â†’ cmd/powershell (drive-by download)
â€¢ WMI â†’ process creation (lateral movement)
â€¢ Services â†’ unusual child (service exploitation)</code></pre>
                
                <h3>Sentinel KQL - Office Spawning Shell</h3>
                
                <pre><code class="language-kql">// Office Applications Spawning Command Shells
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where InitiatingProcessFileName has_any (
    "winword", "excel", "powerpnt", "outlook", "msaccess"
)
| where FileName in~ (
    "cmd.exe", "powershell.exe", "pwsh.exe",
    "wscript.exe", "cscript.exe", "mshta.exe"
)
| project TimeGenerated, DeviceName, AccountName,
    OfficeApp = InitiatingProcessFileName,
    SpawnedProcess = FileName,
    CommandLine = ProcessCommandLine

// Browser Spawning Suspicious Processes
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where InitiatingProcessFileName has_any (
    "chrome", "firefox", "msedge", "iexplore"
)
| where FileName in~ (
    "cmd.exe", "powershell.exe", "certutil.exe",
    "mshta.exe", "wscript.exe", "cscript.exe"
)
| project TimeGenerated, DeviceName, AccountName,
    Browser = InitiatingProcessFileName,
    SpawnedProcess = FileName,
    CommandLine = ProcessCommandLine</code></pre>
                
                <h3>Splunk SPL - Process Chains</h3>
                
                <pre><code class="language-text">// Office Spawning Shells - Splunk
index=windows sourcetype=WinEventLog:Security EventCode=4688
| where match(Creator_Process_Name, "(?i)(winword|excel|powerpnt|outlook)\.exe")
| where match(New_Process_Name, "(?i)(cmd|powershell|wscript|cscript|mshta)\.exe")
| table _time, host, Account_Name, Creator_Process_Name, New_Process_Name, Process_Command_Line</code></pre>
                
                <h2 id="persistence">Use Case: Persistence Mechanisms</h2>
                
                <pre><code class="language-text">USE CASE: PERSISTENCE DETECTION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DESCRIPTION:
Detect establishment of persistence through registry,
scheduled tasks, services, and startup locations.

MITRE ATT&CK:
â€¢ T1547.001 - Registry Run Keys
â€¢ T1053.005 - Scheduled Task
â€¢ T1543.003 - Windows Service
â€¢ T1547.009 - Startup Folder</code></pre>
                
                <h3>Sentinel KQL - Registry Persistence</h3>
                
                <pre><code class="language-kql">// Registry Run Key Modifications
DeviceRegistryEvents
| where TimeGenerated > ago(24h)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any (
    @"\CurrentVersion\Run",
    @"\CurrentVersion\RunOnce",
    @"\CurrentVersion\RunServices",
    @"\Explorer\Shell Folders",
    @"\Explorer\User Shell Folders"
)
// Exclude known legitimate entries
| where RegistryValueData !has "Microsoft"
| where RegistryValueData !has "Windows"
| project TimeGenerated, DeviceName, AccountName,
    RegistryKey, RegistryValueName, RegistryValueData,
    InitiatingProcessFileName

// Service Installation from Unusual Location
DeviceEvents
| where TimeGenerated > ago(24h)
| where ActionType == "ServiceInstalled"
| where FileName !startswith @"C:\Windows\"
| where FileName !startswith @"C:\Program Files"
| project TimeGenerated, DeviceName,
    ServiceName = FileName,
    ServicePath = FolderPath,
    InstalledBy = InitiatingProcessFileName</code></pre>
                
                <h3>Splunk SPL - Scheduled Task Creation</h3>
                
                <pre><code class="language-text">// Suspicious Scheduled Task Creation - Splunk
index=windows sourcetype=WinEventLog:Security EventCode=4698
| rex field=TaskContent "<Command>(?<TaskCommand>[^<]+)</Command>"
| rex field=TaskContent "<Arguments>(?<TaskArgs>[^<]+)</Arguments>"
| where match(TaskCommand, "(?i)(powershell|cmd|wscript|cscript|mshta)")
    OR match(TaskCommand, "(?i)(\\temp\\|\\appdata\\|\\public\\)")
| table _time, host, SubjectUserName, TaskName, TaskCommand, TaskArgs</code></pre>
                
                <h2 id="defense-evasion">Use Case: Defense Evasion</h2>
                
                <pre><code class="language-text">USE CASE: DEFENSE EVASION DETECTION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

INDICATORS:
â€¢ Event log clearing
â€¢ Security tool tampering
â€¢ AMSI bypass attempts
â€¢ Timestomping</code></pre>
                
                <h3>Sentinel KQL - Log Clearing & Tool Tampering</h3>
                
                <pre><code class="language-kql">// Security Event Log Cleared
SecurityEvent
| where TimeGenerated > ago(24h)
| where EventID in (1102, 104)
| project TimeGenerated, Computer, Account,
    EventID, Activity,
    LogCleared = iff(EventID == 1102, "Security", "System")

// Security Tool Process Termination
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "taskkill.exe" or FileName =~ "net.exe"
| where ProcessCommandLine has_any (
    "MsMpEng", "Sense", "MsSense",
    "WinDefend", "SecurityHealth",
    "Symantec", "McAfee", "CrowdStrike", "Carbon Black"
)
| project TimeGenerated, DeviceName, AccountName,
    ProcessCommandLine, InitiatingProcessFileName

// Windows Defender Exclusion Added
DeviceRegistryEvents
| where TimeGenerated > ago(24h)
| where RegistryKey has @"Windows Defender\Exclusions"
| where ActionType == "RegistryValueSet"
| project TimeGenerated, DeviceName, AccountName,
    ExclusionType = RegistryKey,
    ExclusionValue = RegistryValueData</code></pre>
                
                <div class="info-box warning">
                    <div class="info-box-header">
                        <span class="info-box-icon">âš ï¸</span>
                        High-Fidelity Alerts
                    </div>
                    <div class="info-box-content">
                        <p>
                            <strong>These detections rarely have legitimate uses:</strong><br>
                            â–¡ Security log clearing (EventID 1102)<br>
                            â–¡ LSASS memory access by non-system processes<br>
                            â–¡ Office spawning PowerShell with encoded commands<br>
                            â–¡ Certutil downloading executables<br><br>
                            
                            Treat these as HIGH priority and investigate immediately.
                        </p>
                    </div>
                </div>
                
                <div class="info-box interview">
                    <div class="info-box-header">
                        <span class="info-box-icon">ğŸ’¼</span>
                        Interview Question
                    </div>
                    <div class="info-box-content">
                        <p>
                            <strong>"How would you detect malicious PowerShell activity?"</strong><br><br>
                            I would look for multiple indicators:<br><br>
                            
                            <strong>1. Encoded Commands:</strong><br>
                            Search for -enc, -EncodedCommand, FromBase64String flags which are commonly used to obfuscate malicious scripts.<br><br>
                            
                            <strong>2. Download Cradles:</strong><br>
                            Look for IEX, Invoke-WebRequest, Net.WebClient combined with URLs - indicates downloading and executing code from internet.<br><br>
                            
                            <strong>3. Suspicious Parent Processes:</strong><br>
                            Office applications (Word, Excel) or browsers spawning PowerShell often indicates exploitation or macro malware.<br><br>
                            
                            <strong>4. Bypass Flags:</strong><br>
                            -ExecutionPolicy Bypass, -NoProfile, -WindowStyle Hidden suggest attempts to evade controls.<br><br>
                            
                            <strong>Data Sources:</strong><br>
                            Windows Event 4688 with command line logging, or Sysmon Event ID 1, or EDR process telemetry.
                        </p>
                    </div>
                </div>
                
                <h2 id="summary">Chapter Summary</h2>
                
                <ul>
                    <li>PowerShell: Look for encoded commands, download cradles, bypass flags</li>
                    <li>LOLBins: Monitor certutil, mshta, regsvr32 for network/execution activity</li>
                    <li>Process chains: Officeâ†’shell and browserâ†’shell are high-fidelity</li>
                    <li>Persistence: Monitor registry Run keys, scheduled tasks, services</li>
                    <li>Defense evasion: Log clearing and security tool tampering are critical</li>
                </ul>
                
                <div class="page-navigation">
                    <a href="10-1-authentication-attacks.html" class="nav-button prev">
                        <span class="nav-button-icon">â†</span>
                        <div>
                            <span class="nav-button-label">Previous</span>
                            <span class="nav-button-title">Authentication Attacks</span>
                        </div>
                    </a>
                    <a href="10-3-data-exfiltration.html" class="nav-button next">
                        <span class="nav-button-icon">â†’</span>
                        <div>
                            <span class="nav-button-label">Next</span>
                            <span class="nav-button-title">Data Exfiltration</span>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
    
    <script src="main.js"></script>
</body>
</html>
