<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlation Rules - Microsoft Sentinel Guide</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Sentinel Guide
        </a>
        <ul class="navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="architecture.html">Architecture</a></li>
            <li><a href="data-connectors.html">Connectors</a></li>
            <li><a href="analytics-rules.html">Analytics</a></li>
            <li><a href="kql-library.html">KQL Library</a></li>
            <li><a href="automation.html">Automation</a></li>
        </ul>
        <button class="mobile-toggle" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24" fill="none">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Getting Started</div>
            <ul class="sidebar-nav">
                <li><a href="index.html">Home</a></li>
                <li><a href="architecture.html">Architecture</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Data Collection</div>
            <ul class="sidebar-nav">
                <li><a href="data-connectors.html">Data Connectors</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Detection & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="analytics-rules.html">Analytics Rules</a></li>
                <li><a href="connector-rules.html">Connector Rules</a></li>
                <li><a href="correlation-rules.html" class="active">Correlation Rules</a></li>
                <li><a href="kql-library.html">KQL Library</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Investigation & Response</div>
            <ul class="sidebar-nav">
                <li><a href="incidents.html">Incidents</a></li>
                <li><a href="automation.html">Automation & SOAR</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Intelligence & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="workbooks.html">Workbooks</a></li>
                <li><a href="threat-intelligence.html">Threat Intelligence</a></li>
                <li><a href="ueba.html">UEBA</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Management</div>
            <ul class="sidebar-nav">
                <li><a href="content-hub.html">Content Hub</a></li>
                <li><a href="costs.html">Pricing & Costs</a></li>
                <li><a href="best-practices.html">Best Practices</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Quick Resources</div>
            <ul class="sidebar-nav">
                <li><a href="kql-cheatsheet.html">KQL Cheat Sheet</a></li>
                <li><a href="deployment-checklist.html">Deployment Checklist</a></li>
                <li><a href="interview-prep.html">Interview Prep</a></li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <h1>Multi-Connector Correlation Rules</h1>
            <p>Advanced detection rules that correlate signals across multiple data sources to detect sophisticated attack chains and reduce false positives. These rules provide high-fidelity alerts by requiring evidence from multiple systems.</p>

            <!-- Table of Contents -->
            <div class="toc">
                <div class="toc-title">Attack Scenarios</div>
                <ul class="toc-list">
                    <li><a href="#identity-endpoint">Identity + Endpoint Correlation</a></li>
                    <li><a href="#email-endpoint">Email + Endpoint Correlation</a></li>
                    <li><a href="#identity-cloud">Identity + Cloud Apps Correlation</a></li>
                    <li><a href="#phishing-ransomware">Full Attack Chain: Phishing to Ransomware</a></li>
                    <li><a href="#bec">Full Attack Chain: Business Email Compromise</a></li>
                    <li><a href="#insider">Full Attack Chain: Insider Threat</a></li>
                </ul>
            </div>

            <div class="alert alert-info">
                <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                </svg>
                <div class="alert-content">
                    <div class="alert-title">Correlation Benefits</div>
                    <p class="alert-text">Multi-connector rules dramatically reduce false positives by requiring corroborating evidence. A suspicious login alone might be benign, but a suspicious login followed by malware execution on the same device is highly actionable.</p>
                </div>
            </div>

            <!-- Correlation Architecture -->
            <h2>Correlation Architecture</h2>
            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                         MULTI-CONNECTOR CORRELATION ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   DATA SOURCES                    CORRELATION ENGINE                    OUTPUT              │
│   ────────────                    ──────────────────                    ──────              │
│                                                                                              │
│   ┌─────────────────┐                                                                       │
│   │   Azure AD      │──┐                                                                    │
│   │   SigninLogs    │  │                                                                    │
│   └─────────────────┘  │          ┌─────────────────────────────────┐                      │
│                        │          │                                 │                       │
│   ┌─────────────────┐  │          │    ENTITY-BASED CORRELATION     │    ┌──────────────┐  │
│   │   MDE Device    │──┼─────────▶│                                 │───▶│ HIGH-FIDELITY│  │
│   │   Events        │  │          │  • User (UPN, SID)              │    │  INCIDENTS   │  │
│   └─────────────────┘  │          │  • Device (Hostname, DeviceId)  │    │              │  │
│                        │          │  • IP Address                   │    │ Severity:    │  │
│   ┌─────────────────┐  │          │  • Time Window Correlation      │    │ HIGH/CRITICAL│  │
│   │   MDO Email     │──┼─────────▶│                                 │    │              │  │
│   │   Events        │  │          │  Join Keys:                     │    │ FP Rate:     │  │
│   └─────────────────┘  │          │  • UserPrincipalName            │    │ <5%          │  │
│                        │          │  • DeviceName / DeviceId        │    └──────────────┘  │
│   ┌─────────────────┐  │          │  • IPAddress / SourceIP         │                      │
│   │   Firewall      │──┘          │  • TimeGenerated windows        │                      │
│   │   CEF Logs      │             │                                 │                       │
│   └─────────────────┘             └─────────────────────────────────┘                      │
│                                                                                              │
│   CORRELATION PATTERNS:                                                                     │
│   ─────────────────────                                                                     │
│                                                                                              │
│   Pattern 1: Sequential (A then B)                                                          │
│   ┌─────┐    time     ┌─────┐                                                               │
│   │  A  │───────────▶│  B  │    Example: Risky signin → Malware execution                 │
│   └─────┘  (within X) └─────┘                                                               │
│                                                                                              │
│   Pattern 2: Parallel (A and B same time)                                                   │
│   ┌─────┐                                                                                   │
│   │  A  │─────┬─────▶ Alert    Example: Failed logins + Port scan from same IP            │
│   └─────┘     │                                                                             │
│   ┌─────┐     │                                                                             │
│   │  B  │─────┘                                                                             │
│   └─────┘                                                                                   │
│                                                                                              │
│   Pattern 3: Chain (A → B → C → D)                                                         │
│   ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐                                                 │
│   │  A  │───▶│  B  │───▶│  C  │───▶│  D  │  Example: Full kill chain detection            │
│   └─────┘    └─────┘    └─────┘    └─────┘                                                 │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <!-- Identity + Endpoint -->
            <h2 id="identity-endpoint">Identity + Endpoint Correlation</h2>
            <p>Correlate Azure AD sign-in events with endpoint telemetry to detect compromised accounts with suspicious device activity.</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Risky Sign-In Followed by Malware Execution</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1078 + T1204</span>
                        <span class="tag">Multi-Stage</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects a risky or suspicious Azure AD sign-in followed by malware detection on the same device, indicating account compromise leading to endpoint infection.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Data Sources Required</div>
                        <p>Azure AD (SigninLogs) + Microsoft Defender for Endpoint (SecurityAlert, DeviceProcessEvents)</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let timeWindow = 4h;
// Stage 1: Risky sign-ins
let riskySignIns = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where RiskLevelDuringSignIn in ("high", "medium") 
    or RiskState == "atRisk"
    or ResultType in ("50074", "50076", "53003") // MFA/CA failures that succeeded after
| where ResultType == "0" // Ultimately successful
| project 
    SignInTime = TimeGenerated,
    UserPrincipalName,
    IPAddress,
    DeviceDetail,
    Location,
    RiskLevel = RiskLevelDuringSignIn,
    AppDisplayName
| extend DeviceName = tostring(DeviceDetail.displayName);
// Stage 2: Malware/threat alerts on endpoints
let endpointAlerts = SecurityAlert
| where TimeGenerated > ago(timeWindow)
| where ProviderName == "MDATP"
| where AlertSeverity in ("High", "Medium")
| extend DeviceName = tostring(parse_json(ExtendedProperties).DeviceName)
| extend UserName = tostring(parse_json(ExtendedProperties).UserName)
| project 
    AlertTime = TimeGenerated,
    AlertName,
    AlertSeverity,
    DeviceName,
    UserName,
    Description;
// Correlate: Risky sign-in followed by endpoint alert
riskySignIns
| join kind=inner endpointAlerts on DeviceName
| where AlertTime > SignInTime // Alert after sign-in
| where datetime_diff('hour', AlertTime, SignInTime) <= 4 // Within 4 hours
| project 
    TimeGenerated = AlertTime,
    UserPrincipalName,
    DeviceName,
    SignInTime,
    SignInRiskLevel = RiskLevel,
    SignInIP = IPAddress,
    SignInLocation = Location,
    AlertTime,
    AlertName,
    AlertSeverity,
    AttackStage = "Risky SignIn → Endpoint Compromise"</pre>
                            </div>
                        </div>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Entity Mapping</div>
                        <p>Account: UserPrincipalName | Host: DeviceName | IP: IPAddress</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">Response Playbook</div>
                        <p>1. Disable user account 2. Isolate device via MDE 3. Revoke user sessions 4. Initiate investigation</p>
                    </div>
                </div>
            </div>

            <!-- Email + Endpoint -->
            <h2 id="email-endpoint">Email + Endpoint Correlation</h2>
            <p>Correlate email delivery events with endpoint execution to detect successful phishing attacks.</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Phishing Email → Attachment Opened → Malware Execution</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">Critical</span>
                        <span class="tag tag-blue">T1566.001</span>
                        <span class="tag">Attack Chain</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Detects the complete attack chain: phishing email delivered, attachment opened, and malicious process spawned on the endpoint.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let timeWindow = 2h;
// Stage 1: Phishing emails delivered
let phishingEmails = EmailEvents
| where TimeGenerated > ago(timeWindow)
| where ThreatTypes has_any ("Phish", "Malware")
    or DeliveryAction == "Delivered" and ConfidenceLevel in ("High", "Medium")
| join kind=inner (
    EmailAttachmentInfo
    | where TimeGenerated > ago(timeWindow)
    | where FileType in ("exe", "dll", "js", "vbs", "ps1", "bat", "cmd", "hta", "iso", "img")
        or FileName endswith ".doc" or FileName endswith ".docm" 
        or FileName endswith ".xls" or FileName endswith ".xlsm"
) on NetworkMessageId
| project 
    EmailTime = TimeGenerated,
    RecipientEmailAddress,
    SenderFromAddress,
    Subject,
    AttachmentName = FileName,
    AttachmentSHA256 = SHA256,
    ThreatTypes;
// Stage 2: File created/executed on endpoint
let endpointExecution = DeviceFileEvents
| where TimeGenerated > ago(timeWindow)
| where ActionType in ("FileCreated", "FileModified")
| where FolderPath has_any ("Downloads", "Temp", "AppData")
| where FileName endswith ".exe" or FileName endswith ".dll" 
    or InitiatingProcessFileName in ("OUTLOOK.EXE", "WINWORD.EXE", "EXCEL.EXE")
| project 
    FileTime = TimeGenerated,
    DeviceName,
    UserName = InitiatingProcessAccountName,
    FileName,
    FolderPath,
    SHA256,
    InitiatingProcessFileName;
// Stage 3: Suspicious child process from Office or browser
let suspiciousProcess = DeviceProcessEvents
| where TimeGenerated > ago(timeWindow)
| where InitiatingProcessFileName in ("OUTLOOK.EXE", "WINWORD.EXE", "EXCEL.EXE", 
    "POWERPNT.EXE", "chrome.exe", "msedge.exe", "firefox.exe")
| where FileName in ("powershell.exe", "cmd.exe", "wscript.exe", "cscript.exe", 
    "mshta.exe", "regsvr32.exe", "rundll32.exe", "certutil.exe")
| project 
    ProcessTime = TimeGenerated,
    DeviceName,
    AccountName,
    ParentProcess = InitiatingProcessFileName,
    ChildProcess = FileName,
    CommandLine = ProcessCommandLine;
// Correlate all stages
phishingEmails
| join kind=inner (
    endpointExecution
    | extend UserEmail = strcat(UserName, "@", "yourdomain.com") // Adjust domain
) on $left.RecipientEmailAddress == $right.UserEmail
| join kind=inner suspiciousProcess on DeviceName
| where ProcessTime > EmailTime
| where datetime_diff('hour', ProcessTime, EmailTime) <= 2
| project 
    TimeGenerated = ProcessTime,
    RecipientEmailAddress,
    SenderFromAddress,
    EmailSubject = Subject,
    AttachmentName,
    DeviceName,
    ParentProcess,
    SuspiciousChildProcess = ChildProcess,
    CommandLine,
    AttackChain = "Phishing Email → Attachment → Malicious Execution"</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Identity + Cloud -->
            <h2 id="identity-cloud">Identity + Cloud Apps Correlation</h2>
            <p>Correlate Azure AD events with cloud application activity to detect account takeover followed by data exfiltration.</p>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Account Takeover → Mass Data Download</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">Critical</span>
                        <span class="tag tag-blue">T1078 + T1530</span>
                        <span class="tag">Exfiltration</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let timeWindow = 24h;
let downloadThreshold = 50;
// Stage 1: Anomalous sign-in activity
let anomalousSignIns = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where ResultType == "0"
| where RiskLevelDuringSignIn in ("high", "medium")
    or (Location !in (
        SigninLogs 
        | where TimeGenerated > ago(30d) 
        | where UserPrincipalName == UserPrincipalName 
        | distinct Location
    ))
| summarize 
    FirstAnomalousSignIn = min(TimeGenerated),
    AnomalousLocations = make_set(Location),
    AnomalousIPs = make_set(IPAddress)
    by UserPrincipalName;
// Stage 2: Mass file download from cloud apps
let massDownloads = CloudAppEvents
| where TimeGenerated > ago(timeWindow)
| where ActionType in ("FileDownloaded", "FileDownload", "DownloadFile")
| summarize 
    DownloadCount = count(),
    DownloadedFiles = make_set(ObjectName, 20),
    TotalSize = sum(tolong(RawEventData.Size)),
    DownloadStartTime = min(TimeGenerated),
    DownloadEndTime = max(TimeGenerated)
    by UserPrincipalName = AccountDisplayName, Application
| where DownloadCount >= downloadThreshold;
// Correlate
anomalousSignIns
| join kind=inner massDownloads on UserPrincipalName
| where DownloadStartTime > FirstAnomalousSignIn
| project 
    TimeGenerated = DownloadEndTime,
    UserPrincipalName,
    AnomalousSignInTime = FirstAnomalousSignIn,
    AnomalousLocations,
    AnomalousIPs,
    Application,
    FilesDownloaded = DownloadCount,
    SampleFiles = DownloadedFiles,
    DataVolumeBytes = TotalSize,
    AttackChain = "Account Takeover → Mass Data Exfiltration"</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Full Attack Chain: Phishing to Ransomware -->
            <h2 id="phishing-ransomware">Full Attack Chain: Phishing to Ransomware</h2>
            <p>Comprehensive multi-stage detection covering the entire kill chain from initial phishing to ransomware deployment.</p>

            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                     ATTACK CHAIN: PHISHING TO RANSOMWARE                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   Stage 1           Stage 2           Stage 3           Stage 4           Stage 5           │
│   DELIVERY          EXECUTION         PERSISTENCE       LATERAL MOVE      IMPACT            │
│                                                                                              │
│   ┌─────────┐      ┌─────────┐       ┌─────────┐       ┌─────────┐       ┌─────────┐       │
│   │ Phishing│      │ Payload │       │ Registry│       │ PsExec/ │       │ File    │       │
│   │ Email   │─────▶│ Execute │──────▶│ Run Key │──────▶│ WMI     │──────▶│ Encrypt │       │
│   │ Deliver │      │         │       │ Sched   │       │ RDP     │       │ Ransom  │       │
│   └─────────┘      └─────────┘       └─────────┘       └─────────┘       └─────────┘       │
│                                                                                              │
│   Data Source:      Data Source:      Data Source:      Data Source:      Data Source:      │
│   MDO EmailEvents   MDE Process       MDE Registry      MDE Network       MDE File          │
│                     Events            Events            + MDI             Events            │
│                                                                                              │
│   Detection:        Detection:        Detection:        Detection:        Detection:        │
│   - Phish verdict   - Suspicious      - Run key add     - SMB/WMI to      - Mass file       │
│   - Malware attach  - PowerShell      - Sched task      multiple hosts    - Ransom ext      │
│   - URL click       - Child of Office - Service install - New device      - Delete backups  │
│                                                                                              │
│   Time Window: Minutes               Hours               Hours             Minutes           │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Complete Ransomware Attack Chain Detection</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">Critical</span>
                        <span class="tag tag-blue">T1566→T1059→T1547→T1021→T1486</span>
                        <span class="tag">Kill Chain</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let lookback = 24h;
// Stage 1: Initial Access via Phishing
let stage1_phishing = EmailEvents
| where TimeGenerated > ago(lookback)
| where ThreatTypes has_any ("Phish", "Malware") or ConfidenceLevel == "High"
| where DeliveryAction == "Delivered"
| project 
    Stage1_Time = TimeGenerated,
    RecipientEmailAddress,
    SenderFromAddress,
    Subject,
    NetworkMessageId;
// Stage 2: Execution - Suspicious process from email client/attachment
let stage2_execution = DeviceProcessEvents
| where TimeGenerated > ago(lookback)
| where InitiatingProcessFileName in ("OUTLOOK.EXE", "WINWORD.EXE", "EXCEL.EXE")
    or FolderPath has "Downloads" or FolderPath has "Temp"
| where FileName in ("powershell.exe", "cmd.exe", "wscript.exe", "mshta.exe", "regsvr32.exe")
    or ProcessCommandLine has_any ("-enc", "downloadstring", "IEX", "bypass")
| project 
    Stage2_Time = TimeGenerated,
    DeviceName,
    AccountName,
    Stage2_Process = FileName,
    Stage2_CommandLine = ProcessCommandLine;
// Stage 3: Persistence - Registry or scheduled task
let stage3_persistence = DeviceRegistryEvents
| where TimeGenerated > ago(lookback)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any ("Run", "RunOnce", "Winlogon")
| project 
    Stage3_Time = TimeGenerated,
    DeviceName,
    Stage3_RegistryKey = RegistryKey,
    Stage3_Value = RegistryValueData
| union (
    DeviceProcessEvents
    | where TimeGenerated > ago(lookback)
    | where ProcessCommandLine has "schtasks" and ProcessCommandLine has "/create"
    | project 
        Stage3_Time = TimeGenerated,
        DeviceName,
        Stage3_RegistryKey = "ScheduledTask",
        Stage3_Value = ProcessCommandLine
);
// Stage 4: Lateral Movement
let stage4_lateral = DeviceNetworkEvents
| where TimeGenerated > ago(lookback)
| where RemotePort in (445, 135, 139, 5985) // SMB, RPC, WinRM
| where RemoteIPType == "Private"
| summarize 
    Stage4_Time = min(TimeGenerated),
    TargetDevices = make_set(RemoteIP),
    LateralCount = dcount(RemoteIP)
    by DeviceName, InitiatingProcessFileName
| where LateralCount >= 3;
// Stage 5: Impact - Ransomware indicators
let stage5_ransomware = DeviceFileEvents
| where TimeGenerated > ago(lookback)
| where ActionType in ("FileCreated", "FileModified", "FileRenamed")
| where FileName matches regex @"\.(encrypted|locked|crypto|crypt|enc)$"
    or FolderPath has "ransom" or FolderPath has "README"
| summarize 
    Stage5_Time = min(TimeGenerated),
    EncryptedFiles = count(),
    AffectedFolders = dcount(FolderPath),
    SampleFiles = make_set(FileName, 10)
    by DeviceName
| where EncryptedFiles >= 20;
// Correlate all stages
stage2_execution
| join kind=inner stage3_persistence on DeviceName
| join kind=inner stage4_lateral on DeviceName
| join kind=inner stage5_ransomware on DeviceName
| where Stage3_Time > Stage2_Time
| where Stage4_Time > Stage3_Time
| where Stage5_Time > Stage4_Time
| project 
    TimeGenerated = Stage5_Time,
    DeviceName,
    InitialUser = AccountName,
    ExecutionTime = Stage2_Time,
    ExecutionProcess = Stage2_Process,
    PersistenceTime = Stage3_Time,
    PersistenceMechanism = Stage3_RegistryKey,
    LateralMovementTime = Stage4_Time,
    TargetDevices,
    RansomwareTime = Stage5_Time,
    EncryptedFileCount = EncryptedFiles,
    AttackChainComplete = "PHISHING → EXECUTION → PERSISTENCE → LATERAL → RANSOMWARE"</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Email Compromise -->
            <h2 id="bec">Full Attack Chain: Business Email Compromise</h2>
            
            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">BEC Attack Chain - Account Takeover to Financial Fraud</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">Critical</span>
                        <span class="tag tag-blue">T1078 + T1114 + T1534</span>
                        <span class="tag">Financial Fraud</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let lookback = 7d;
// Stage 1: Credential compromise (password spray or phishing success)
let stage1_compromise = SigninLogs
| where TimeGenerated > ago(lookback)
| where ResultType == "0" // Successful
| where RiskLevelDuringSignIn in ("high", "medium")
    or ConditionalAccessStatus == "failure" // CA failed but login succeeded
| project 
    CompromiseTime = TimeGenerated,
    UserPrincipalName,
    CompromiseIP = IPAddress,
    CompromiseLocation = Location;
// Stage 2: Inbox rule created (to hide emails)
let stage2_inboxRule = AuditLogs
| where TimeGenerated > ago(lookback)
| where OperationName in ("New-InboxRule", "Set-InboxRule", "UpdateInboxRules")
| extend RuleDetails = tostring(TargetResources[0].modifiedProperties)
| where RuleDetails has_any ("DeleteMessage", "MoveToFolder", "ForwardTo", "RedirectTo")
    or RuleDetails has_any ("invoice", "payment", "wire", "bank", "urgent")
| project 
    RuleTime = TimeGenerated,
    UserPrincipalName = tostring(InitiatedBy.user.userPrincipalName),
    RuleName = tostring(TargetResources[0].displayName),
    RuleDetails;
// Stage 3: Email forwarding to external
let stage3_forwarding = AuditLogs
| where TimeGenerated > ago(lookback)
| where OperationName has_any ("Set-Mailbox", "New-TransportRule")
| extend TargetEmail = tostring(TargetResources[0].modifiedProperties)
| where TargetEmail has "@" and TargetEmail !has "yourdomain.com"
| project 
    ForwardTime = TimeGenerated,
    UserPrincipalName = tostring(InitiatedBy.user.userPrincipalName),
    ExternalForwardTarget = TargetEmail;
// Stage 4: Financial-themed emails sent
let stage4_financialEmails = EmailEvents
| where TimeGenerated > ago(lookback)
| where EmailDirection == "Outbound"
| where Subject has_any ("invoice", "payment", "wire transfer", "urgent", 
    "bank account", "routing number", "ACH", "account change")
| project 
    EmailSentTime = TimeGenerated,
    SenderFromAddress,
    RecipientEmailAddress,
    Subject;
// Correlate BEC chain
stage1_compromise
| join kind=inner stage2_inboxRule on UserPrincipalName
| join kind=leftouter stage3_forwarding on UserPrincipalName
| where RuleTime > CompromiseTime
| project 
    TimeGenerated = RuleTime,
    CompromisedUser = UserPrincipalName,
    CompromiseTime,
    CompromiseIP,
    CompromiseLocation,
    InboxRuleCreated = RuleName,
    RuleTime,
    ExternalForwardTarget,
    BECIndicators = "Account Compromise + Inbox Rule + External Forward"</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insider Threat -->
            <h2 id="insider">Full Attack Chain: Insider Threat</h2>

            <div class="rule-card">
                <div class="rule-header">
                    <h4 class="rule-title">Insider Threat - Data Exfiltration by Departing Employee</h4>
                    <div class="rule-meta">
                        <span class="tag tag-red">High</span>
                        <span class="tag tag-blue">T1048 + T1052</span>
                        <span class="tag">Insider Threat</span>
                    </div>
                </div>
                <div class="rule-body">
                    <div class="rule-section">
                        <div class="rule-section-title">Description</div>
                        <p>Correlates HR watchlist (departing employees) with unusual data access patterns and exfiltration indicators.</p>
                    </div>
                    <div class="rule-section">
                        <div class="rule-section-title">KQL Query</div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">KQL</span>
                                <button class="copy-btn">
                                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <div class="code-content">
<pre>let lookback = 14d;
// Get departing employees from watchlist
let departingEmployees = _GetWatchlist('DepartingEmployees')
| project UserPrincipalName, DepartureDate, Department;
// Unusual login hours
let unusualHours = SigninLogs
| where TimeGenerated > ago(lookback)
| where hourofday(TimeGenerated) < 6 or hourofday(TimeGenerated) > 22
| where dayofweek(TimeGenerated) in (0, 6) // Weekend
| summarize UnusualLogins = count() by UserPrincipalName;
// Mass file access
let massFileAccess = CloudAppEvents
| where TimeGenerated > ago(lookback)
| where ActionType in ("FileDownloaded", "FilePreviewed", "FileAccessed")
| summarize 
    FilesAccessed = count(),
    UniqueFiles = dcount(ObjectName),
    DataVolume = sum(tolong(RawEventData.Size))
    by UserPrincipalName = AccountDisplayName;
// USB device activity
let usbActivity = DeviceEvents
| where TimeGenerated > ago(lookback)
| where ActionType == "PnpDeviceConnected"
| where DeviceDescription has_any ("USB", "Removable", "Mass Storage")
| summarize 
    USBDevices = dcount(DeviceId),
    USBConnections = count()
    by DeviceName, AccountName;
// Personal cloud upload (via firewall)
let personalCloudUpload = CommonSecurityLog
| where TimeGenerated > ago(lookback)
| where DestinationHostName has_any (
    "dropbox.com", "drive.google.com", "onedrive.live.com", 
    "wetransfer.com", "sendspace.com", "mega.nz"
)
| where SentBytes > 10000000 // >10MB
| summarize 
    UploadEvents = count(),
    TotalUploaded = sum(SentBytes)
    by SourceUserName, DestinationHostName;
// Correlate all signals
departingEmployees
| join kind=inner massFileAccess on UserPrincipalName
| join kind=leftouter unusualHours on UserPrincipalName
| where FilesAccessed > 100 or UnusualLogins > 5
| project 
    TimeGenerated = now(),
    UserPrincipalName,
    DepartureDate,
    Department,
    FilesAccessed,
    UniqueFilesAccessed = UniqueFiles,
    DataAccessedBytes = DataVolume,
    UnusualLoginCount = UnusualLogins,
    InsiderRiskScore = (FilesAccessed / 100) + (UnusualLogins * 2)</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-warning">
                <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div class="alert-content">
                    <div class="alert-title">Watchlist Dependency</div>
                    <p class="alert-text">Insider threat rules require a watchlist of departing/at-risk employees from HR. Create this watchlist in Sentinel and populate via HR integration or manual upload.</p>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="footer-content">
                    <svg class="footer-icon" viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    Microsoft Sentinel Ultimate Guide
                </div>
            </footer>
        </div>
    </main>

    <script src="main.js"></script>
</body>
</html>
