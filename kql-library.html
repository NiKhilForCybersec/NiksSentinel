<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Query Library - Microsoft Sentinel Guide</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Sentinel Guide
        </a>
        <ul class="navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="architecture.html">Architecture</a></li>
            <li><a href="data-connectors.html">Connectors</a></li>
            <li><a href="analytics-rules.html">Analytics</a></li>
            <li><a href="kql-library.html" class="active">KQL Library</a></li>
            <li><a href="automation.html">Automation</a></li>
        </ul>
        <button class="mobile-toggle" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24" fill="none">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Getting Started</div>
            <ul class="sidebar-nav">
                <li><a href="index.html">Home</a></li>
                <li><a href="architecture.html">Architecture</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Data Collection</div>
            <ul class="sidebar-nav">
                <li><a href="data-connectors.html">Data Connectors</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Detection & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="analytics-rules.html">Analytics Rules</a></li>
                <li><a href="connector-rules.html">Connector Rules</a></li>
                <li><a href="correlation-rules.html">Correlation Rules</a></li>
                <li><a href="kql-library.html" class="active">KQL Library</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Investigation & Response</div>
            <ul class="sidebar-nav">
                <li><a href="incidents.html">Incidents</a></li>
                <li><a href="automation.html">Automation & SOAR</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Intelligence & Analytics</div>
            <ul class="sidebar-nav">
                <li><a href="workbooks.html">Workbooks</a></li>
                <li><a href="threat-intelligence.html">Threat Intelligence</a></li>
                <li><a href="ueba.html">UEBA</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Management</div>
            <ul class="sidebar-nav">
                <li><a href="content-hub.html">Content Hub</a></li>
                <li><a href="costs.html">Pricing & Costs</a></li>
                <li><a href="best-practices.html">Best Practices</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Quick Resources</div>
            <ul class="sidebar-nav">
                <li><a href="kql-cheatsheet.html">KQL Cheat Sheet</a></li>
                <li><a href="deployment-checklist.html">Deployment Checklist</a></li>
                <li><a href="interview-prep.html">Interview Prep</a></li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <h1>KQL Query Library</h1>
            <p>A comprehensive collection of 50+ ready-to-use KQL queries for threat hunting, investigation, and operational monitoring. Each query is tested and includes explanations for customization.</p>

            <!-- Table of Contents -->
            <div class="toc">
                <div class="toc-title">Query Categories</div>
                <ul class="toc-list">
                    <li><a href="#fundamentals">KQL Fundamentals</a></li>
                    <li><a href="#identity">Identity & Access Hunting</a></li>
                    <li><a href="#endpoint">Endpoint Hunting</a></li>
                    <li><a href="#network">Network Hunting</a></li>
                    <li><a href="#cloud">Cloud & Azure Hunting</a></li>
                    <li><a href="#email">Email & Office 365 Hunting</a></li>
                    <li><a href="#operations">Operational Queries</a></li>
                    <li><a href="#investigation">Investigation Queries</a></li>
                </ul>
            </div>

            <!-- KQL Fundamentals -->
            <h2 id="fundamentals">KQL Fundamentals</h2>
            <p>Essential KQL operators and patterns for building effective queries.</p>

            <div class="ascii-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              KQL QUERY STRUCTURE                                             │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   TableName                    ← Start with table                                           │
│   | where TimeGenerated > ago(24h)    ← Filter time first (performance)                    │
│   | where Column == "value"           ← Filter specific conditions                         │
│   | extend NewColumn = expression     ← Create calculated columns                          │
│   | summarize count() by GroupCol     ← Aggregate data                                     │
│   | order by count_ desc              ← Sort results                                       │
│   | take 100                          ← Limit output                                       │
│   | project Col1, Col2, Col3          ← Select final columns                              │
│                                                                                              │
│   PERFORMANCE TIPS:                                                                         │
│   ─────────────────                                                                         │
│   1. Always filter by TimeGenerated FIRST                                                   │
│   2. Use "has" instead of "contains" for better performance                                 │
│   3. Filter before join/summarize operations                                                │
│   4. Use "in" instead of multiple "or" conditions                                           │
│   5. Project only needed columns at the end                                                 │
│                                                                                              │
│   COMMON OPERATORS:                                                                         │
│   ─────────────────                                                                         │
│   ==, !=        Exact match                    has, !has       Contains word               │
│   =~, !~        Case-insensitive match         has_any         Contains any of list        │
│   contains      Substring match (slow)         has_all         Contains all of list        │
│   startswith    Starts with string             in, !in         In list of values           │
│   matches regex Regular expression match       between         Range comparison            │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
            </div>

            <h3>Essential KQL Patterns</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Time Functions</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>// Time windows
| where TimeGenerated > ago(1h)           // Last hour
| where TimeGenerated > ago(7d)           // Last 7 days
| where TimeGenerated between (ago(7d) .. ago(1d))  // 7 days ago to 1 day ago

// Extract time components
| extend Hour = hourofday(TimeGenerated)
| extend DayOfWeek = dayofweek(TimeGenerated)  // 0=Sunday, 6=Saturday
| extend WeekOfYear = week_of_year(TimeGenerated)

// Time binning for charts
| summarize count() by bin(TimeGenerated, 1h)  // Hourly buckets
| summarize count() by bin(TimeGenerated, 1d)  // Daily buckets

// Business hours filter (Mon-Fri, 8am-6pm)
| where dayofweek(TimeGenerated) between (1 .. 5)
| where hourofday(TimeGenerated) between (8 .. 18)</pre>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - String Operations</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>// Extract username from UPN
| extend Username = tostring(split(UserPrincipalName, "@")[0])
| extend Domain = tostring(split(UserPrincipalName, "@")[1])

// Extract from DOMAIN\User format
| extend Username = tostring(split(Account, "\\")[1])
| extend Domain = tostring(split(Account, "\\")[0])

// Parse structured data
| parse CommandLine with * "-user " Username " -pass " Password *
| parse EventData with * '<Data Name="TargetUserName">' TargetUser '</Data>' *

// Regular expressions
| where ProcessCommandLine matches regex @"[A-Za-z0-9+/]{50,}={0,2}"  // Base64
| extend ExtractedIP = extract(@"(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})", 1, Message)

// String manipulation
| extend Lower = tolower(FileName)
| extend Upper = toupper(FileName)
| extend Trimmed = trim(" ", RawData)
| extend Replaced = replace_string(Path, "\\", "/")</pre>
                </div>
            </div>

            <!-- Identity Hunting -->
            <h2 id="identity">Identity & Access Hunting</h2>
            <p>Queries for hunting identity-based threats in Azure AD and Active Directory.</p>

            <h3>1. Failed Logins by Country (Unusual Geolocations)</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>SigninLogs
| where TimeGenerated > ago(7d)
| where ResultType != "0"
| summarize 
    FailedAttempts = count(),
    DistinctUsers = dcount(UserPrincipalName),
    SampleUsers = make_set(UserPrincipalName, 5)
    by Location, tostring(LocationDetails.countryOrRegion)
| order by FailedAttempts desc
| take 20</pre>
                </div>
            </div>

            <h3>2. Impossible Travel Detection</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let maxSpeedKmH = 800; // Max reasonable speed (commercial flight)
SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType == "0"
| extend Latitude = toreal(LocationDetails.geoCoordinates.latitude)
| extend Longitude = toreal(LocationDetails.geoCoordinates.longitude)
| where isnotempty(Latitude)
| order by UserPrincipalName, TimeGenerated
| extend 
    PrevLat = prev(Latitude),
    PrevLon = prev(Longitude),
    PrevTime = prev(TimeGenerated),
    PrevUser = prev(UserPrincipalName)
| where UserPrincipalName == PrevUser
| extend 
    TimeDiffHours = datetime_diff('hour', TimeGenerated, PrevTime),
    // Haversine formula approximation
    DistanceKm = geo_distance_2points(Longitude, Latitude, PrevLon, PrevLat) / 1000
| where TimeDiffHours > 0
| extend SpeedKmH = DistanceKm / TimeDiffHours
| where SpeedKmH > maxSpeedKmH
| project 
    TimeGenerated,
    UserPrincipalName,
    FromLocation = strcat(PrevLat, ", ", PrevLon),
    ToLocation = strcat(Latitude, ", ", Longitude),
    TimeDiffHours,
    DistanceKm,
    SpeedKmH</pre>
                </div>
            </div>

            <h3>3. Accounts with MFA Disabled</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>AuditLogs
| where TimeGenerated > ago(30d)
| where OperationName in ("Disable Strong Authentication", "Admin disabled MFA")
| extend TargetUser = tostring(TargetResources[0].userPrincipalName)
| extend InitiatingUser = tostring(InitiatedBy.user.userPrincipalName)
| project 
    TimeGenerated,
    TargetUser,
    InitiatingUser,
    OperationName,
    Result</pre>
                </div>
            </div>

            <h3>4. Service Principal Credential Added</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>AuditLogs
| where TimeGenerated > ago(7d)
| where OperationName has_any ("Add service principal credentials", "Update application – Certificates and secrets management")
| extend AppName = tostring(TargetResources[0].displayName)
| extend AppId = tostring(TargetResources[0].id)
| extend InitiatingUser = tostring(InitiatedBy.user.userPrincipalName)
| project 
    TimeGenerated,
    AppName,
    AppId,
    InitiatingUser,
    OperationName,
    Result</pre>
                </div>
            </div>

            <h3>5. Privileged Role Assignments</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let privilegedRoles = dynamic([
    "Global Administrator", "Privileged Role Administrator", 
    "Security Administrator", "Exchange Administrator",
    "SharePoint Administrator", "User Administrator"
]);
AuditLogs
| where TimeGenerated > ago(30d)
| where OperationName has "Add member to role"
| extend RoleName = tostring(TargetResources[0].displayName)
| where RoleName in (privilegedRoles)
| extend TargetUser = tostring(TargetResources[0].userPrincipalName)
| extend InitiatingUser = tostring(InitiatedBy.user.userPrincipalName)
| project 
    TimeGenerated,
    TargetUser,
    RoleName,
    InitiatingUser,
    Result</pre>
                </div>
            </div>

            <h3>6. Guest User Invitations</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>AuditLogs
| where TimeGenerated > ago(30d)
| where OperationName == "Invite external user"
| extend InvitedEmail = tostring(TargetResources[0].userPrincipalName)
| extend InvitedBy = tostring(InitiatedBy.user.userPrincipalName)
| extend InvitedDomain = tostring(split(InvitedEmail, "@")[1])
| summarize 
    InvitationCount = count(),
    InvitedUsers = make_set(InvitedEmail)
    by InvitedBy, InvitedDomain, bin(TimeGenerated, 1d)
| order by InvitationCount desc</pre>
                </div>
            </div>

            <!-- Endpoint Hunting -->
            <h2 id="endpoint">Endpoint Hunting</h2>
            <p>Queries for hunting endpoint-based threats using MDE telemetry.</p>

            <h3>7. Suspicious PowerShell Execution</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName =~ "powershell.exe" or FileName =~ "pwsh.exe"
| where ProcessCommandLine has_any (
    // Encoding/Obfuscation
    "-enc", "-encodedcommand", "FromBase64String", "[Convert]::FromBase64",
    // Download cradles
    "Invoke-WebRequest", "IWR", "wget", "curl", "DownloadString", "DownloadFile",
    "Invoke-Expression", "IEX", "Start-BitsTransfer",
    // AMSI bypass
    "AmsiUtils", "amsiInitFailed", "SetValue", "NonPublic",
    // Credential theft
    "Get-Credential", "SecureString", "mimikatz",
    // Execution policy bypass
    "-ep bypass", "-executionpolicy bypass", "Set-ExecutionPolicy"
)
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    FolderPath
| order by TimeGenerated desc</pre>
                </div>
            </div>

            <h3>8. LOLBins Execution (Living Off the Land)</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let lolbins = dynamic([
    "certutil.exe", "mshta.exe", "regsvr32.exe", "rundll32.exe",
    "msiexec.exe", "wmic.exe", "cscript.exe", "wscript.exe",
    "installutil.exe", "regasm.exe", "regsvcs.exe", "msbuild.exe",
    "cmstp.exe", "msxsl.exe", "odbcconf.exe", "ieexec.exe"
]);
DeviceProcessEvents
| where TimeGenerated > ago(24h)
| where FileName in~ (lolbins)
| where ProcessCommandLine has_any ("http", "ftp", "\\\\", "/c ", "/k ", "-enc")
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    FileName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine
| extend 
    ThreatIndicator = case(
        ProcessCommandLine has "http", "Download",
        ProcessCommandLine has "\\\\", "Network Path",
        ProcessCommandLine has "-enc", "Encoded Command",
        "Suspicious Execution"
    )</pre>
                </div>
            </div>

            <h3>9. Persistence via Registry Run Keys</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>DeviceRegistryEvents
| where TimeGenerated > ago(7d)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any (
    @"\Software\Microsoft\Windows\CurrentVersion\Run",
    @"\Software\Microsoft\Windows\CurrentVersion\RunOnce",
    @"\Software\Microsoft\Windows\CurrentVersion\RunServices",
    @"\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run"
)
| where RegistryValueData has_any (".exe", ".dll", ".bat", ".cmd", ".ps1", ".vbs", ".js")
| project 
    TimeGenerated,
    DeviceName,
    InitiatingProcessAccountName,
    RegistryKey,
    RegistryValueName,
    RegistryValueData,
    InitiatingProcessFileName</pre>
                </div>
            </div>

            <h3>10. Scheduled Task Creation</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>DeviceProcessEvents
| where TimeGenerated > ago(7d)
| where FileName =~ "schtasks.exe"
| where ProcessCommandLine has "/create"
| parse ProcessCommandLine with * "/tn " TaskName " " * "/tr " TaskAction *
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    TaskName = trim('"', TaskName),
    TaskAction = trim('"', TaskAction),
    FullCommandLine = ProcessCommandLine,
    InitiatingProcessFileName
| where TaskAction has_any (".exe", ".dll", ".bat", ".ps1", "powershell", "cmd")</pre>
                </div>
            </div>

            <h3>11. WMI Event Subscription (Persistence)</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>DeviceEvents
| where TimeGenerated > ago(7d)
| where ActionType == "WmiBindEventFilterToConsumer"
| extend WmiConsumerType = tostring(AdditionalFields.ConsumerType)
| extend WmiConsumerName = tostring(AdditionalFields.ConsumerName)
| extend WmiFilterName = tostring(AdditionalFields.FilterName)
| project 
    TimeGenerated,
    DeviceName,
    InitiatingProcessAccountName,
    WmiConsumerType,
    WmiConsumerName,
    WmiFilterName,
    InitiatingProcessFileName</pre>
                </div>
            </div>

            <h3>12. Suspicious File Downloads</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let suspiciousExtensions = dynamic([".exe", ".dll", ".ps1", ".bat", ".vbs", ".js", ".hta", ".iso", ".img"]);
DeviceFileEvents
| where TimeGenerated > ago(24h)
| where ActionType == "FileCreated"
| where FolderPath has_any ("Downloads", "Temp", "AppData\\Local\\Temp")
| where FileName has_any (suspiciousExtensions)
| where InitiatingProcessFileName in~ ("chrome.exe", "firefox.exe", "msedge.exe", "iexplore.exe", 
    "outlook.exe", "winword.exe", "excel.exe", "powerpnt.exe")
| project 
    TimeGenerated,
    DeviceName,
    InitiatingProcessAccountName,
    FileName,
    FolderPath,
    FileSize,
    SHA256,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine</pre>
                </div>
            </div>

            <!-- Network Hunting -->
            <h2 id="network">Network Hunting</h2>
            <p>Queries for hunting network-based threats.</p>

            <h3>13. DNS Tunneling Detection</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>DnsEvents
| where TimeGenerated > ago(24h)
| extend SubdomainLength = strlen(tostring(split(Name, ".")[0]))
| extend TotalDomainLength = strlen(Name)
| where SubdomainLength > 30 or TotalDomainLength > 50
| summarize 
    QueryCount = count(),
    AvgSubdomainLength = avg(SubdomainLength),
    SampleQueries = make_set(Name, 5)
    by ClientIP, bin(TimeGenerated, 1h)
| where QueryCount > 50 and AvgSubdomainLength > 30
| project 
    TimeGenerated,
    ClientIP,
    QueryCount,
    AvgSubdomainLength,
    SampleQueries,
    TunnelingIndicator = "High volume of long subdomain queries"</pre>
                </div>
            </div>

            <h3>14. Connections to Rare Domains</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>// Find domains accessed by few devices (potential C2)
DeviceNetworkEvents
| where TimeGenerated > ago(7d)
| where isnotempty(RemoteUrl)
| extend Domain = tostring(parse_url(RemoteUrl).Host)
| where isnotempty(Domain)
| summarize 
    DeviceCount = dcount(DeviceName),
    Devices = make_set(DeviceName, 10),
    ConnectionCount = count()
    by Domain
| where DeviceCount == 1 and ConnectionCount > 10
| order by ConnectionCount desc
| take 50</pre>
                </div>
            </div>

            <h3>15. Outbound Connections to Non-Standard Ports</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let standardPorts = dynamic([20, 21, 22, 23, 25, 53, 80, 110, 143, 443, 445, 993, 995, 3389]);
DeviceNetworkEvents
| where TimeGenerated > ago(24h)
| where ActionType == "ConnectionSuccess"
| where RemoteIPType == "Public"
| where RemotePort !in (standardPorts)
| where RemotePort > 1024
| summarize 
    ConnectionCount = count(),
    DataTransferred = sum(tolong(AdditionalFields.TransferredBytes)),
    Devices = make_set(DeviceName)
    by RemoteIP, RemotePort, InitiatingProcessFileName
| where ConnectionCount > 5
| order by DataTransferred desc</pre>
                </div>
            </div>

            <!-- Cloud Hunting -->
            <h2 id="cloud">Cloud & Azure Hunting</h2>
            <p>Queries for hunting threats in Azure infrastructure.</p>

            <h3>16. Azure Resource Deletions</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>AzureActivity
| where TimeGenerated > ago(24h)
| where OperationNameValue has "delete"
| where ActivityStatusValue == "Success"
| summarize 
    DeletionCount = count(),
    DeletedResources = make_set(Resource, 10)
    by Caller, ResourceGroup, bin(TimeGenerated, 1h)
| where DeletionCount > 5
| order by DeletionCount desc</pre>
                </div>
            </div>

            <h3>17. VM Creation Outside Normal Hours</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>AzureActivity
| where TimeGenerated > ago(7d)
| where OperationNameValue == "MICROSOFT.COMPUTE/VIRTUALMACHINES/WRITE"
| where ActivityStatusValue == "Success"
| extend Hour = hourofday(TimeGenerated)
| extend DayOfWeek = dayofweek(TimeGenerated)
| where Hour < 7 or Hour > 20 or DayOfWeek in (0, 6) // Outside business hours or weekend
| project 
    TimeGenerated,
    Caller,
    ResourceGroup,
    Resource,
    SubscriptionId,
    CallerIpAddress</pre>
                </div>
            </div>

            <h3>18. Storage Account Anonymous Access Enabled</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>AzureActivity
| where TimeGenerated > ago(7d)
| where OperationNameValue has "MICROSOFT.STORAGE/STORAGEACCOUNTS"
| where ActivityStatusValue == "Success"
| extend Properties = parse_json(Properties)
| where Properties has "publicNetworkAccess" or Properties has "allowBlobPublicAccess"
| project 
    TimeGenerated,
    Caller,
    ResourceGroup,
    Resource,
    Properties</pre>
                </div>
            </div>

            <!-- Email Hunting -->
            <h2 id="email">Email & Office 365 Hunting</h2>
            <p>Queries for hunting email-based threats using MDO data.</p>

            <h3>19. Phishing Emails that Bypassed Filters</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>EmailEvents
| where TimeGenerated > ago(7d)
| where DeliveryAction == "Delivered"
| where ThreatTypes has_any ("Phish", "Malware") or ConfidenceLevel == "High"
| project 
    TimeGenerated,
    RecipientEmailAddress,
    SenderFromAddress,
    Subject,
    ThreatTypes,
    DeliveryAction,
    NetworkMessageId
| join kind=leftouter (
    EmailUrlInfo
    | where TimeGenerated > ago(7d)
) on NetworkMessageId
| project 
    TimeGenerated,
    Recipient = RecipientEmailAddress,
    Sender = SenderFromAddress,
    Subject,
    ThreatTypes,
    UrlsInEmail = Url</pre>
                </div>
            </div>

            <h3>20. Mass Email Forwarding Rules Created</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>OfficeActivity
| where TimeGenerated > ago(7d)
| where Operation in ("New-InboxRule", "Set-InboxRule", "Enable-InboxRule")
| extend Parameters = parse_json(Parameters)
| mv-expand Parameters
| where Parameters.Name in ("ForwardTo", "ForwardAsAttachmentTo", "RedirectTo")
| extend ForwardingAddress = tostring(Parameters.Value)
| where isnotempty(ForwardingAddress)
| project 
    TimeGenerated,
    UserId,
    Operation,
    ForwardingAddress,
    ClientIP,
    RuleName = tostring(Parameters.Name)</pre>
                </div>
            </div>

            <!-- Operations -->
            <h2 id="operations">Operational Queries</h2>
            <p>Queries for monitoring Sentinel health and data ingestion.</p>

            <h3>21. Data Ingestion Volume by Table</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>Usage
| where TimeGenerated > ago(30d)
| summarize 
    TotalGB = sum(Quantity) / 1024,
    AvgDailyGB = sum(Quantity) / 1024 / 30
    by DataType
| order by TotalGB desc
| extend EstimatedMonthlyCost = TotalGB * 2.76 // Adjust rate as needed</pre>
                </div>
            </div>

            <h3>22. Connector Health Check</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let tables = dynamic([
    "SigninLogs", "AuditLogs", "SecurityEvent", "DeviceProcessEvents",
    "CommonSecurityLog", "Syslog", "AzureActivity", "EmailEvents"
]);
union withsource=TableName *
| where TimeGenerated > ago(24h)
| where TableName in (tables)
| summarize 
    LastEvent = max(TimeGenerated),
    EventCount = count()
    by TableName
| extend 
    HoursSinceLastEvent = datetime_diff('hour', now(), LastEvent),
    Status = iff(datetime_diff('hour', now(), LastEvent) > 2, "⚠️ Delayed", "✅ Healthy")
| order by HoursSinceLastEvent desc</pre>
                </div>
            </div>

            <h3>23. Analytics Rule Health</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>SentinelHealth
| where TimeGenerated > ago(7d)
| where SentinelResourceType == "Analytics Rule"
| where Status != "Success"
| summarize 
    FailureCount = count(),
    LastFailure = max(TimeGenerated)
    by SentinelResourceName, Description
| order by FailureCount desc</pre>
                </div>
            </div>

            <!-- Investigation -->
            <h2 id="investigation">Investigation Queries</h2>
            <p>Queries for investigating specific incidents.</p>

            <h3>24. All Activity for a Specific User</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let targetUser = "user@domain.com";
let timeWindow = 24h;
// Sign-ins
let signins = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where UserPrincipalName =~ targetUser
| project TimeGenerated, Activity = "SignIn", Details = strcat(AppDisplayName, " from ", IPAddress), Result = ResultType;
// Audit events
let audits = AuditLogs
| where TimeGenerated > ago(timeWindow)
| where InitiatedBy.user.userPrincipalName =~ targetUser
| project TimeGenerated, Activity = "AuditAction", Details = OperationName, Result = ResultDescription;
// Cloud app events
let cloudApps = CloudAppEvents
| where TimeGenerated > ago(timeWindow)
| where AccountDisplayName =~ targetUser
| project TimeGenerated, Activity = "CloudApp", Details = strcat(Application, ": ", ActionType), Result = "N/A";
// Union all
union signins, audits, cloudApps
| order by TimeGenerated desc</pre>
                </div>
            </div>

            <h3>25. All Activity for a Specific Device</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let targetDevice = "WORKSTATION-001";
let timeWindow = 24h;
// Process events
let processes = DeviceProcessEvents
| where TimeGenerated > ago(timeWindow)
| where DeviceName =~ targetDevice
| project TimeGenerated, EventType = "Process", Details = strcat(FileName, " - ", ProcessCommandLine);
// Network events
let network = DeviceNetworkEvents
| where TimeGenerated > ago(timeWindow)
| where DeviceName =~ targetDevice
| project TimeGenerated, EventType = "Network", Details = strcat(RemoteIP, ":", RemotePort, " via ", InitiatingProcessFileName);
// File events
let files = DeviceFileEvents
| where TimeGenerated > ago(timeWindow)
| where DeviceName =~ targetDevice
| project TimeGenerated, EventType = "File", Details = strcat(ActionType, ": ", FolderPath, "\\", FileName);
// Union all
union processes, network, files
| order by TimeGenerated desc</pre>
                </div>
            </div>

            <h3>26. All Activity for a Specific IP</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL</span>
                    <button class="copy-btn">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
                        Copy
                    </button>
                </div>
                <div class="code-content">
<pre>let targetIP = "192.168.1.100";
let timeWindow = 7d;
// Sign-ins from this IP
let signins = SigninLogs
| where TimeGenerated > ago(timeWindow)
| where IPAddress == targetIP
| project TimeGenerated, Source = "SignIn", User = UserPrincipalName, Details = AppDisplayName;
// Firewall events
let firewall = CommonSecurityLog
| where TimeGenerated > ago(timeWindow)
| where SourceIP == targetIP or DestinationIP == targetIP
| project TimeGenerated, Source = "Firewall", User = SourceUserName, Details = strcat(DeviceAction, " to ", DestinationIP, ":", DestinationPort);
// Network events
let network = DeviceNetworkEvents
| where TimeGenerated > ago(timeWindow)
| where RemoteIP == targetIP or LocalIP == targetIP
| project TimeGenerated, Source = "Endpoint", User = InitiatingProcessAccountName, Details = strcat(DeviceName, " -> ", RemoteIP);
union signins, firewall, network
| order by TimeGenerated desc</pre>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="footer-content">
                    <svg class="footer-icon" viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    Microsoft Sentinel Ultimate Guide
                </div>
            </footer>
        </div>
    </main>

    <script src="main.js"></script>
</body>
</html>
